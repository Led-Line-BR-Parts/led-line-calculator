<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED LINE BR PARTS - CALCULADORA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LED LINE Calculadora">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#0d838c">
    <link rel="manifest" href="manifest.json">
    
    <!-- Fonts e CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- PDF.js para exporta√ß√£o PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
         /* Estilo para cards com imagens */
    .item-image {
        width: 100%;
        height: 160px;
        border-radius: 8px;
        margin-bottom: 10px;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
    }
    
    /* Visualiza√ß√£o de imagem no modal de compartilhamento */
    .share-image {
        width: 100%;
        height: 180px;
        border-radius: 8px;
        margin-bottom: 15px;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
    }
    
    /* √çcone para quando n√£o h√° imagem */
    .no-image {
        font-size: 36px;
        opacity: 0.3;
    }
        :root {
            --primary: #0d838c;
            --primary-dark: #0a6a71;
            --secondary: #0d838c;
            --success: #0d838c;
            --danger: #000000;
            --warning: #333333;
            --light: #ffffff;
            --dark: #000000;
            --gray: #333333;
            --gray-light: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --background: #f0f2f5;
            --text: #212529;
            --card-bg: #ffffff;
        }
        
        /* Tema escuro */
        [data-theme="dark"] {
            --primary: #0d838c;
            --primary-dark: #0a6a71;
            --secondary: #0d838c;
            --success: #0d838c;
            --danger: #000000;
            --warning: #555555;
            --light: #333333;
            --dark: #ffffff;
            --gray: #cccccc;
            --gray-light: #444444;
            --background: #121212;
            --text: #f0f0f0;
            --card-bg: #1e1e1e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        header p {
            color: var(--gray);
            font-size: 1rem;
        }

        .theme-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .theme-switch label {
            margin: 0 10px;
            cursor: pointer;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15);
        }
        
        .taxas-info {
            background-color: rgba(13, 131, 140, 0.05);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        
        .taxas-info h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .taxas-info button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.3rem 0.8rem;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .taxas-info ul {
            padding-left: 1.5rem;
        }
        
        .taxas-info li {
            margin-bottom: 0.25rem;
        }

        .taxas-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: rgba(13, 131, 140, 0.1);
            border-radius: var(--border-radius);
        }

        .taxas-form .form-row {
            display: flex;
            margin-bottom: 0.8rem;
            align-items: center;
        }

        .taxas-form label {
            flex: 1;
            margin-bottom: 0;
        }

        .taxas-form input {
            width: 100px;
            margin-left: 1rem;
        }

        .taxas-form button {
            margin-top: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .tooltip {
            display: inline-block;
            margin-left: 5px;
            color: var(--primary);
            cursor: pointer;
            position: relative;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: var(--light);
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
            background-color: var(--light);
            color: var(--dark);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 131, 140, 0.2);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        button i {
            margin-right: 0.5rem;
        }
        
        .result {
            display: none;
            margin-top: 2rem;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .result h3 {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            margin: 0;
            font-size: 1.2rem;
        }
        
        #resultadoDetalhes {
            padding: 1.5rem;
        }
        
        #resultadoDetalhes p {
            margin-bottom: 0.75rem;
        }
        
        #resultadoDetalhes hr {
            margin: 1rem 0;
            border: none;
            border-top: 1px solid var(--gray-light);
        }
        
        #resultadoDetalhes ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        #resultadoDetalhes li {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        
        #resultadoDetalhes li span:first-child {
            color: var(--gray);
        }
        
        #resultadoDetalhes li span:last-child {
            font-weight: 500;
        }
        
        #resultadoDetalhes p:last-of-type {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            padding: 1rem;
            background-color: rgba(13, 131, 140, 0.05);
            border-radius: var(--border-radius);
            margin-top: 1.5rem;
        }
        
        #salvarBtn, .btn-primary {
            background-color: var(--success);
            margin-top: 1rem;
        }
        
        #salvarBtn:hover, .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .chart-container {
            margin-top: 1rem;
            width: 100%;
            height: 300px;
        }
        
        .saved-items {
            margin-top: 2.5rem;
        }
        
        .saved-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .saved-items h3 {
            font-size: 1.3rem;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
            display: inline-block;
            margin-bottom: 0;
        }
        
        .saved-items-actions {
            display: flex;
            gap: 1rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            width: auto;
        }
        
        .search-container {
            display: flex;
            margin-bottom: 1.5rem;
        }
        
        .search-container input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .search-container button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            width: auto;
        }
        
        .item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.2rem;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }
        
        .item:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .item h4 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
        }
        
        .item-details {
            margin-bottom: 1rem;
        }
        
        .item-details p {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        
        .item-details p strong {
            color: var(--gray);
        }
        
        .item-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .edit-btn {
            background-color: var(--warning);
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #222222;
        }
        
        .delete-btn {
            background-color: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #222222;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }

        .col-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 0 15px;
        }

        /* Tabs sistema */
        .tabs {
            margin-bottom: 20px;
            display: flex;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .tab-button {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--dark);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            width: auto;
        }
        
        .tab-button.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Hist√≥rico de cota√ß√µes */
        .cotacao-chart {
            height: 250px;
            margin: 20px 0;
        }
        
        /* Clientes */
        .client-list {
            margin-top: 20px;
        }
        
        .client-item {
            border-bottom: 1px solid var(--gray-light);
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Sistema de login */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 500px;
            animation: modal-in 0.3s;
        }
        
        @keyframes modal-in {
            from { 
                opacity: 0; 
                transform: translateY(-50px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .close-modal {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Compartilhamento */
        .share-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .share-option i {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: black;
        }

        /* Tabela para visualiza√ß√£o em formato tabela */
        .table-view {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            color: var(--text);
        }

        .table-view th, .table-view td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .table-view th {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }

        .table-view tr:hover {
            background-color: rgba(13, 131, 140, 0.05);
        }

        /* Status de conex√£o */
        .connection-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: var(--border-radius);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            z-index: 999;
            display: none;
        }

        .connection-status.online {
            background-color: rgba(40, 167, 69, 0.8);
        }

        .connection-status.offline {
            background-color: rgba(220, 53, 69, 0.8);
        }

        @media (max-width: 768px) {
            .col-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .row {
                flex-direction: column;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .item-actions {
                flex-direction: column;
            }

            .theme-switch {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 1rem;
                justify-content: center;
            }
            
            .saved-items-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .saved-items-actions {
                margin-top: 10px;
                width: 100%;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 5px;
            }

            .table-view {
                font-size: 14px;
            }

            .table-view th, .table-view td {
                padding: 8px 10px;
            }

            .share-options {
                flex-wrap: wrap;
            }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Loading spinner */
        .loader {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* Pulsating effect for live elements */
        .live-update {
            animation: pulse 2s infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Instala√ß√£o PWA */
        .install-banner {
            display: none;
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            align-items: center;
            justify-content: space-between;
        }

        .install-banner button {
            margin: 0 0 0 15px;
            width: auto;
            padding: 5px 15px;
            background-color: white;
            color: var(--primary);
        }

        .install-banner button:hover {
            background-color: var(--light);
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Login / Cadastro</h3>
            <div class="login-form">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha">
                </div>
                <button id="loginBtn" class="btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
                <p style="text-align: center; margin-top: 15px;">Ou</p>
                <button id="registerBtn" class="btn-primary"><i class="fas fa-user-plus"></i> Criar Conta</button>
            </div>
        </div>
    </div>
    
    <!-- Compartilhar Modal -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Compartilhar Or√ßamento</h3>
            <div id="shareContent"></div>
            <div class="share-options">
                <div class="share-option" id="shareWhatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp</span>
                </div>
                <div class="share-option" id="shareEmail">
                    <i class="fas fa-envelope"></i>
                    <span>Email</span>
                </div>
                <div class="share-option" id="sharePdf">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF</span>
                </div>
                <div class="share-option" id="shareLink">
                    <i class="fas fa-link"></i>
                    <span>Link</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clientes Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Adicionar Cliente</h3>
            <div class="form-group">
                <label for="clientName">Nome do Cliente:</label>
                <input type="text" id="clientName" placeholder="Nome completo">
            </div>
            <div class="form-group">
                <label for="clientEmail">Email:</label>
                <input type="email" id="clientEmail" placeholder="cliente@email.com">
            </div>
            <div class="form-group">
                <label for="clientPhone">Telefone:</label>
                <input type="text" id="clientPhone" placeholder="(00) 00000-0000">
            </div>
            <div class="form-group">
                <label for="clientNotes">Observa√ß√µes:</label>
                <div class="form-group">
    <label for="produtoImagem">
        Foto do Produto:
        <span class="tooltip"><i class="fas fa-info-circle"></i>
            <span class="tooltip-text">Adicione uma foto do produto para o or√ßamento.</span>
        </span>
    </label>
    <div style="display: flex; align-items: center; gap: 10px;">
        <input type="file" id="produtoImagem" accept="image/*" style="display: none;">
        <button type="button" id="selecionarImagemBtn" style="width: auto; background-color: #555;">
            <i class="fas fa-image"></i> Selecionar Imagem
        </button>
        <div id="previewImagem" style="display: none; width: 80px; height: 80px; border-radius: 5px; background-size: cover; background-position: center;"></div>
        <button type="button" id="removerImagemBtn" style="display: none; width: auto; background-color: #e63946;">
            <i class="fas fa-trash"></i> Remover
        </button>
    </div>
</div>
                <textarea id="clientNotes" rows="3" placeholder="Informa√ß√µes adicionais"></textarea>
            </div>
            <button id="saveClientBtn" class="btn-primary"><i class="fas fa-save"></i> Salvar Cliente</button>
        </div>
    </div>
    
    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification"></div>

    <!-- Status de conex√£o -->
    <div id="connectionStatus" class="connection-status"></div>

    <!-- Banner de instala√ß√£o PWA -->
    <div id="installBanner" class="install-banner">
        <span>Instale esta aplica√ß√£o para uso offline!</span>
        <button id="installBtn"><i class="fas fa-download"></i> Instalar</button>
    </div>

    <div class="container">
        <div class="theme-switch">
            <label>üåû</label>
            <label class="switch">
                <input type="checkbox" id="theme-toggle">
                <span class="slider"></span>
            </label>
            <label>üåô</label>
        </div>
        
        <header>
            <h1>LED LINE BR PARTS - CALCULADORA</h1>
            <p>Calcule o pre√ßo final considerando todas as taxas</p>
            
            <!-- Status de login -->
            <div id="userStatus" style="margin-top: 10px;">
                <button id="loginStatusBtn" class="btn-small"><i class="fas fa-user"></i> Entrar</button>
                <span id="userInfo" style="display: none;"></span>
            </div>
        </header>
        
        <!-- Sistema de abas -->
        <div class="tabs">
            <button class="tab-button active" data-tab="calculator">Calculadora</button>
            <button class="tab-button" data-tab="history">Hist√≥rico</button>
            <button class="tab-button" data-tab="clients">Clientes</button>
            <button class="tab-button" data-tab="dashboard">Dashboard</button>
        </div>
        
        <!-- Aba da Calculadora -->
        <div id="calculator" class="tab-content active">
            <div class="card">
                <div class="taxas-info">
                    <h3>
                        Taxas Aplicadas:
                        <button id="editarTaxasBtn"><i class="fas fa-edit"></i> Editar</button>
                    </h3>
                    <ul id="taxasList">
                        <li id="taxaCartaoItem">Parcelamento sem juros (Cart√£o): <span id="taxaParcelamentoDisplay">14.35</span>%</li>
                        <li id="taxaPixItem" style="display: none;">Taxa Pix: <span id="taxaPixDisplay">0.79</span>%</li>
                        <li>Yampi: <span id="taxaYampiDisplay">2.5</span>%</li>
                        <li>Imposto: <span id="taxaImpostoDisplay">10</span>%</li>
                    </ul>
                    
                    <div class="taxas-form" id="taxasForm">
                        <div class="form-row">
                            <label for="taxaParcelamento">Parcelamento sem juros (Cart√£o) (%):</label>
                            <input type="number" id="taxaParcelamento" step="0.01" min="0" value="14.35">
                        </div>
                        <div class="form-row">
                            <label for="taxaPix">Taxa Pix (%):</label>
                            <input type="number" id="taxaPix" step="0.01" min="0" value="0.79">
                        </div>
                        <div class="form-row">
                            <label for="taxaYampi">Yampi (%):</label>
                            <input type="number" id="taxaYampi" step="0.01" min="0" value="2.5">
                        </div>
                        <div class="form-row">
                            <label for="taxaImposto">Imposto (%):</label>
                            <input type="number" id="taxaImposto" step="0.01" min="0" value="10">
                        </div>
                        <button id="salvarTaxasBtn"><i class="fas fa-save"></i> Salvar</button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="nomeProduto">
                                Nome do Produto:
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Nome ou descri√ß√£o do produto para identifica√ß√£o.</span>
                                </span>
                            </label>
                            <input type="text" id="nomeProduto" placeholder="Ex: Camiseta Estampada">
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="form-group">
                            <label for="dataCotacao">
                                Data da Cota√ß√£o:
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Data em que foi realizada a cota√ß√£o do d√≥lar.</span>
                                </span>
                            </label>
                            <input type="date" id="dataCotacao">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="custoDolar">
                                Custo em D√≥lar ($):
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Pre√ßo de custo do produto em d√≥lares americanos.</span>
                                </span>
                            </label>
                            <input type="number" id="custoDolar" step="0.01" min="0" placeholder="Ex: 10.50">
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="form-group">
                            <label for="cotacaoDolar">
                                Cota√ß√£o do D√≥lar (R$):
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Valor atual do d√≥lar em reais. Atualiza automaticamente.</span>
                                </span>
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="cotacaoDolar" step="0.01" min="0" placeholder="Ex: 5.20">
                                <button id="atualizarDolarBtn" style="width: auto;"><i class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="margemLucro">
                                Margem de Lucro (%):
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Porcentagem de lucro desejada sobre o custo.</span>
                                </span>
                            </label>
                            <input type="number" id="margemLucro" step="0.1" min="0" placeholder="Ex: 40">
                        </div>
                    </div>
                    <div class="row">
    <div class="col-6">
        <div class="form-group">
            <label for="valorVendaDesejado">
                Valor de Venda Desejado (R$):
                <span class="tooltip"><i class="fas fa-info-circle"></i>
                    <span class="tooltip-text">Insira o valor de venda desejado para calcular o lucro e margem correspondente.</span>
                </span>
            </label>
            <input type="number" id="valorVendaDesejado" step="0.01" min="0" placeholder="Ex: 99.90">
        </div>
    </div>
    
    <div class="col-6">
        <div class="form-group">
            <label for="calcularLucroBtn">&nbsp;</label>
            <button id="calcularLucroBtn" style="width: 100%;"><i class="fas fa-percentage"></i> Calcular Lucro</button>
        </div>
    </div>
</div>

<div id="resultadoLucro" style="display: none; margin: 15px 0; padding: 15px; border-radius: var(--border-radius); background-color: var(--primary); color: white;">
    <p style="margin: 0; font-weight: 500; font-size: 16px;">Resultados do Valor de Venda Desejado:</p>
    <div id="detalhesLucro"></div>
</div>
                    <div class="col-6">
                        <div class="form-group">
                            <label for="quantidade">
                                Quantidade:
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">N√∫mero de unidades do produto.</span>
                                </span>
                            </label>
                            <input type="number" id="quantidade" step="1" min="1" value="1" placeholder="Ex: 10">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="metodoPagamento">
                                M√©todo de Pagamento:
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Pix tem taxa de 0,79% em vez de 14,35% do cart√£o.</span>
                                </span>
                            </label>
                            <select id="metodoPagamento">
                                <option value="cartao">Cart√£o de Cr√©dito</option>
                                <option value="pix">Pix</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="form-group">
                            <label for="clienteSelect">
                                Cliente:
                                <span class="tooltip"><i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Associe este or√ßamento a um cliente.</span>
                                </span>
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <select id="clienteSelect">
                                    <option value="">Selecione um cliente</option>
                                </select>
                                <button id="addClienteBtn" style="width: auto;"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes:</label>
                    <textarea id="observacoes" rows="3" placeholder="Informa√ß√µes adicionais sobre este or√ßamento..."></textarea>
                </div>
                
                <button id="calcularBtn"><i class="fas fa-calculator"></i> Calcular Pre√ßo</button>
                
                <div class="result" id="resultado">
                    <h3>Resultado do C√°lculo</h3>
                    <div id="resultadoDetalhes"></div>
                    <div class="chart-container">
                        <canvas id="graficoDistribuicao"></canvas>
                    </div>
                    <div style="padding: 0 1.5rem 1.5rem;">
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="salvarBtn"><i class="fas fa-save"></i> Salvar Or√ßamento</button>
                            <button id="compartilharBtn"><i class="fas fa-share-alt"></i> Compartilhar</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="saved-items">
                <div class="saved-items-header">
                    <h3>Or√ßamentos Salvos</h3>
                    <div class="saved-items-actions">
                        <button class="btn-small" id="exportarCSVBtn"><i class="fas fa-file-export"></i> Exportar CSV</button>
                        <button class="btn-small" id="exportarExcelBtn"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                        <button class="btn-small" id="limparDadosBtn"><i class="fas fa-trash-alt"></i> Limpar Todos</button>
                    </div>
                </div>
                
                <div class="search-container">
                    <input type="text" id="filtroOrcamentos" placeholder="Buscar or√ßamentos...">
                    <button id="buscarBtn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="view-switch" style="margin-bottom: 15px;">
                    <button class="active btn-small" id="cardViewBtn"><i class="fas fa-th-large"></i> Cards</button>
                    <button class="btn-small" id="tableViewBtn"><i class="fas fa-table"></i> Tabela</button>
                </div>
                
                <div id="itensSalvos"></div>
            </div>
        </div>
        
        <!-- Aba de Hist√≥rico -->
        <div id="history" class="tab-content">
            <div class="card">
                <h3>Hist√≥rico de Cota√ß√µes do D√≥lar</h3>
                <p>Acompanhe a evolu√ß√£o da cota√ß√£o do d√≥lar nos √∫ltimos 30 dias.</p>
                
                <div class="cotacao-chart">
                    <canvas id="cotacaoChart"></canvas>
                </div>
                
                <h4>Alertas de Cota√ß√£o</h4>
                <div class="form-group">
                    <label for="alertaValor">Valor do D√≥lar para Alerta:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="alertaValor" step="0.01" min="0" placeholder="Ex: 5.00">
                        <button id="setAlertaBtn" style="width: auto;"><i class="fas fa-bell"></i> Definir Alerta</button>
                    </div>
                    <small>Voc√™ ser√° notificado quando o d√≥lar atingir este valor.</small>
                </div>
                
                <div id="alertasAtivos" style="margin-top: 15px;">
                    <!-- Alertas ativos ser√£o mostrados aqui -->
                </div>
            </div>
        </div>
        
        <!-- Aba de Clientes -->
        <div id="clients" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Gerenciamento de Clientes</h3>
                    <button id="newClientBtn" class="btn-small"><i class="fas fa-user-plus"></i> Novo Cliente</button>
                </div>
                
                <div class="search-container">
                    <input type="text" id="filtroClientes" placeholder="Buscar clientes...">
                    <button id="buscarClientesBtn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="client-list" id="clientList">
                    <!-- Lista de clientes ser√° carregada aqui -->
                </div>
            </div>
        </div>
        
        <!-- Aba de Dashboard -->
        <div id="dashboard" class="tab-content">
            <div class="card">
                <h3>Dashboard de Vendas</h3>
                <p>Visualize o desempenho dos seus or√ßamentos e vendas.</p>
                
                <div class="row">
                    <div class="col-6">
                        <div style="background-color: rgba(13, 131, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4>Total de Or√ßamentos</h4>
                            <p style="font-size: 24px; font-weight: 600; color: var(--primary);" id="totalOrcamentos">0</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div style="background-color: rgba(13, 131, 140, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4>Valor Total</h4>
                            <p style="font-size: 24px; font-weight: 600; color: var(--primary);" id="valorTotal">R$ 0,00</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Distribui√ß√£o por M√©todo de Pagamento</h4>
                    <canvas id="paymentMethodChart" height="200"></canvas>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Or√ßamentos por M√™s</h4>
                    <canvas id="monthlyBudgetChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

      // Vari√°veis para armazenar a imagem
    let imagemProduto = null;
    let imagemBase64 = null;
    
    // Adicionar eventos relacionados a imagens
    document.addEventListener('DOMContentLoaded', function() {
        const selecionarImagemBtn = document.getElementById('selecionarImagemBtn');
        const inputImagem = document.getElementById('produtoImagem');
        const previewImagem = document.getElementById('previewImagem');
        const removerImagemBtn = document.getElementById('removerImagemBtn');
        
        // Evento para abrir seletor de arquivo ao clicar no bot√£o
        selecionarImagemBtn.addEventListener('click', function() {
            inputImagem.click();
        });
        
        // Evento ao selecionar um arquivo
        inputImagem.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Verificar se √© uma imagem
                if (!file.type.startsWith('image/')) {
                    mostrarNotificacao('Por favor, selecione apenas arquivos de imagem.', 'error');
                    return;
                }
                
                // Verificar tamanho (limite de 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    mostrarNotificacao('A imagem √© muito grande. O tamanho m√°ximo √© 2MB.', 'error');
                    return;
                }
                
                // Salvar refer√™ncia do arquivo
                imagemProduto = file;
                
                // Criar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImagem.style.backgroundImage = `url('${e.target.result}')`;
                    previewImagem.style.display = 'block';
                    removerImagemBtn.style.display = 'block';
                    
                    // Guardar base64 para armazenamento local
                    imagemBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Evento para remover imagem
        removerImagemBtn.addEventListener('click', function() {
            imagemProduto = null;
            imagemBase64 = null;
            inputImagem.value = '';
            previewImagem.style.backgroundImage = '';
            previewImagem.style.display = 'none';
            removerImagemBtn.style.display = 'none';
        });
    });
    
    // Modificar a fun√ß√£o salvarItem para incluir a imagem
    function salvarItem(item) {
        // Adicionar imagem ao item
        if (imagemBase64) {
            item.imagem = imagemBase64;
        }
        
        // O resto da fun√ß√£o permanece igual
        // Obter itens salvos do localStorage
        let itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Adicionar novo item
        itensSalvos.push(item);
        
        // Salvar no localStorage
        localStorage.setItem('calculadoraLucro', JSON.stringify(itensSalvos));
        
        // Atualizar dashboard
        atualizarDashboard();
        
        // Recarregar lista de itens
        carregarItensSalvos();
        
        // Limpar formul√°rio
        document.getElementById('nomeProduto').value = '';
        document.getElementById('custoDolar').value = '';
        document.getElementById('margemLucro').value = '';
        document.getElementById('quantidade').value = '1';
        document.getElementById('observacoes').value = '';
        
        // Limpar imagem do produto
        imagemProduto = null;
        imagemBase64 = null;
        document.getElementById('produtoImagem').value = '';
        document.getElementById('previewImagem').style.backgroundImage = '';
        document.getElementById('previewImagem').style.display = 'none';
        document.getElementById('removerImagemBtn').style.display = 'none';
        
        // Ocultar resultado
        document.getElementById('resultado').style.display = 'none';
        
        mostrarNotificacao('Or√ßamento salvo com sucesso!');
        
        // Se o usu√°rio estiver logado e o Firebase estiver configurado, salvar na nuvem
        if (usuarioAtual && firebase.apps.length > 0) {
            salvarItemNaNuvem(item, usuarioAtual.uid);
        }
    }
    
    // Modificar a fun√ß√£o exibirItensCardHTML para mostrar a imagem
    function exibirItensCardHTML(itensSalvos, itensSalvosDiv) {
        itensSalvosDiv.innerHTML = '';
        
        itensSalvos.forEach(item => {
            const quantidade = item.quantidade || 1;
            const metodoPagamento = item.metodoPagamento === 'pix' ? 'Pix' : 'Cart√£o de Cr√©dito';
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            
            // Preparar HTML da imagem
            const imagemHTML = item.imagem ? 
                `<div class="item-image" style="background-image: url('${item.imagem}');"></div>` : 
                `<div class="item-image"><i class="fas fa-image no-image"></i></div>`;
            
            itemDiv.innerHTML = `
                ${imagemHTML}
                <h4>${item.nomeProduto}</h4>
                <div class="item-details">
                    <p><strong>Data:</strong> ${formatarData(item.dataCotacao)}</p>
                    <p><strong>Custo em D√≥lar:</strong> ${formatarMoeda(item.custoDolar, 'USD')} (Cota√ß√£o ${formatarMoeda(item.cotacaoDolar, 'BRL')})</p>
                    <p><strong>Margem de Lucro Desejada:</strong> ${item.margemLucro}%</p>
                    <p><strong>M√©todo de Pagamento:</strong> ${metodoPagamento}</p>
                    <p><strong>Pre√ßo Unit√°rio:</strong> ${formatarMoeda(item.precoFinal, 'BRL')}</p>
                    <p><strong>Quantidade:</strong> ${quantidade} unidades</p>
                    <p><strong>Pre√ßo Total:</strong> ${formatarMoeda(item.precoFinal * quantidade, 'BRL')}</p>
                    <p><strong>Lucro Real:</strong> ${formatarMoeda(item.lucroReal || 0, 'BRL')} (${(item.percentualLucroReal || 0).toFixed(2)}%)</p>
                    ${item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : ''}
                    ${item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : ''}
                </div>
                <div class="item-actions">
                    <button class="edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Editar</button>
                    <button class="share-btn" data-id="${item.id}" style="background-color: #4895ef;"><i class="fas fa-share-alt"></i> Compartilhar</button>
                    <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Excluir</button>
                </div>
            `;
            itensSalvosDiv.appendChild(itemDiv);
        });
    }
    
    // Modificar a fun√ß√£o abrirModalCompartilhar para incluir a imagem
    function abrirModalCompartilhar(item) {
        const modal = document.getElementById('shareModal');
        const shareContent = document.getElementById('shareContent');
        
        const cliente = item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : '';
        const observacoes = item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : '';
        
        // Incluir imagem no modal se dispon√≠vel
        const imagemHTML = item.imagem ? 
            `<div class="share-image" style="background-image: url('${item.imagem}');"></div>` : '';
        
        // Preencher conte√∫do do modal
        shareContent.innerHTML = `
            <div style="margin-bottom: 20px;">
                ${imagemHTML}
                <h4 style="margin-bottom: 10px;">${item.nomeProduto}</h4>
                <p><strong>Pre√ßo Unit√°rio:</strong> ${formatarMoeda(item.precoFinal, 'BRL')}</p>
                <p><strong>Quantidade:</strong> ${item.quantidade || 1} unidades</p>
                <p><strong>Pre√ßo Total:</strong> ${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}</p>
                ${cliente}
                ${observacoes}
            </div>
        `;
        
        // Armazenar o item atual para compartilhamento
        window.itemParaCompartilhar = item;
        
        // Exibir modal
        modal.style.display = 'block';
    }
    
    // Modificar a fun√ß√£o editarItem para carregar a imagem
    function editarItem(id) {
        // Obter itens salvos
        const itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Encontrar item pelo id
        const item = itensSalvos.find(item => item.id == id);
        
        if (!item) {
            mostrarNotificacao('Item n√£o encontrado!', 'error');
            return;
        }
        
        // Mudar para a aba da calculadora
        document.querySelector('.tab-button[data-tab="calculator"]').click();
        
        // Preencher formul√°rio com dados do item
        document.getElementById('nomeProduto').value = item.nomeProduto;
        document.getElementById('dataCotacao').value = item.dataCotacao;
        document.getElementById('custoDolar').value = item.custoDolar;
        document.getElementById('cotacaoDolar').value = item.cotacaoDolar;
        document.getElementById('margemLucro').value = item.margemLucro;
        document.getElementById('quantidade').value = item.quantidade || 1;
        document.getElementById('observacoes').value = item.observacoes || '';
        
        // Carregar imagem se dispon√≠vel
        if (item.imagem) {
            imagemBase64 = item.imagem;
            document.getElementById('previewImagem').style.backgroundImage = `url('${item.imagem}')`;
            document.getElementById('previewImagem').style.display = 'block';
            document.getElementById('removerImagemBtn').style.display = 'block';
        } else {
            imagemBase64 = null;
            document.getElementById('previewImagem').style.backgroundImage = '';
            document.getElementById('previewImagem').style.display = 'none';
            document.getElementById('removerImagemBtn').style.display = 'none';
        }
        
        if (item.metodoPagamento) {
            document.getElementById('metodoPagamento').value = item.metodoPagamento;
            toggleTaxaDisplay(); // Atualizar exibi√ß√£o de taxas
        }
        
        if (item.clienteId) {
            document.getElementById('clienteSelect').value = item.clienteId;
        }
        
        // Rolar para o formul√°rio
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        
        // Calcular pre√ßo para mostrar resultado
        calcularPreco();
        
        // Pegar o bot√£o de salvar que foi criado ao calcular o pre√ßo
        const salvarBtn = document.getElementById('salvarBtn');
        
        // Atualizar texto e evento do bot√£o
        salvarBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Edi√ß√£o';
        
        // Remover eventos anteriores (clonar e substituir o bot√£o)
        const novoSalvarBtn = salvarBtn.cloneNode(true);
        salvarBtn.parentNode.replaceChild(novoSalvarBtn, salvarBtn);
        
        // Adicionar novo evento
        novoSalvarBtn.addEventListener('click', function() {
            // Remover item antigo
            excluirItem(id, false);
            
            // Salvar como novo item
            salvarItem(window.calculoAtual);
            
            mostrarNotificacao('Or√ßamento atualizado com sucesso!');
        });
    }
    
    // Modificar a fun√ß√£o compartilharPDF para incluir a imagem
    function compartilharPDF() {
        const item = window.itemParaCompartilhar;
        
        if (!item) return;
        
        // Preparar conte√∫do para PDF
        const content = document.createElement('div');
        
        // Incluir imagem se dispon√≠vel
        const imagemHTML = item.imagem ? 
            `<div style="width: 100%; height: 200px; background-image: url('${item.imagem}'); background-size: contain; background-position: center; background-repeat: no-repeat; margin-bottom: 20px;"></div>` : '';
        
        content.innerHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="color: #0d838c; text-align: center;">LED LINE BR PARTS</h1>
                <h2 style="text-align: center;">Or√ßamento</h2>
                
                <div style="margin-top: 30px;">
                    ${imagemHTML}
                    <h3 style="color: #0d838c;">${item.nomeProduto}</h3>
                    <p><strong>Data:</strong> ${formatarData(item.dataCotacao)}</p>
                    ${item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Item</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Valor</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Custo em D√≥lar</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.custoDolar, 'USD')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Cota√ß√£o do D√≥lar</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.cotacaoDolar, 'BRL')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Pre√ßo Unit√°rio</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.precoFinal, 'BRL')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Quantidade</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${item.quantidade || 1} unidades</td>
                        </tr>
                        <tr style="font-weight: bold; background-color: #f2f2f2;">
                            <td style="padding: 10px; border: 1px solid #ddd;">Pre√ßo Total</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}</td>
                        </tr>
                    </table>
                    
                    ${item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : ''}
                    
                    <div style="margin-top: 30px; font-size: 12px; color: #666; text-align: center;">
                        <p>Or√ßamento gerado em ${formatarData(new Date().toISOString())}</p>
                        <p>LED LINE BR PARTS</p>
                    </div>
                </div>
            </div>
        `;
        
        // Colocar elemento na p√°gina temporariamente
        document.body.appendChild(content);
        
        // Usar html2canvas e jsPDF para gerar PDF
        html2canvas(content).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`orcamento_${item.nomeProduto.replace(/\s+/g, '_')}.pdf`);
            
            // Remover elemento tempor√°rio
            document.body.removeChild(content);
            
            // Fechar modal
            document.getElementById('shareModal').style.display = 'none';
        });
    }

    <!-- Script principal do aplicativo -->
    <script>
          // Vari√°veis para armazenar a imagem
    let imagemProduto = null;
    let imagemBase64 = null;
    
    // Adicionar eventos relacionados a imagens
    document.addEventListener('DOMContentLoaded', function() {
        const selecionarImagemBtn = document.getElementById('selecionarImagemBtn');
        const inputImagem = document.getElementById('produtoImagem');
        const previewImagem = document.getElementById('previewImagem');
        const removerImagemBtn = document.getElementById('removerImagemBtn');
        
        // Evento para abrir seletor de arquivo ao clicar no bot√£o
        selecionarImagemBtn.addEventListener('click', function() {
            inputImagem.click();
        });
        
        // Evento ao selecionar um arquivo
        inputImagem.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Verificar se √© uma imagem
                if (!file.type.startsWith('image/')) {
                    mostrarNotificacao('Por favor, selecione apenas arquivos de imagem.', 'error');
                    return;
                }
                
                // Verificar tamanho (limite de 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    mostrarNotificacao('A imagem √© muito grande. O tamanho m√°ximo √© 2MB.', 'error');
                    return;
                }
                
                // Salvar refer√™ncia do arquivo
                imagemProduto = file;
                
                // Criar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImagem.style.backgroundImage = `url('${e.target.result}')`;
                    previewImagem.style.display = 'block';
                    removerImagemBtn.style.display = 'block';
                    
                    // Guardar base64 para armazenamento local
                    imagemBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Evento para remover imagem
        removerImagemBtn.addEventListener('click', function() {
            imagemProduto = null;
            imagemBase64 = null;
            inputImagem.value = '';
            previewImagem.style.backgroundImage = '';
            previewImagem.style.display = 'none';
            removerImagemBtn.style.display = 'none';
        });
    });
    
    // Modificar a fun√ß√£o salvarItem para incluir a imagem
    function salvarItem(item) {
        // Adicionar imagem ao item
        if (imagemBase64) {
            item.imagem = imagemBase64;
        }
        
        // O resto da fun√ß√£o permanece igual
        // Obter itens salvos do localStorage
        let itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Adicionar novo item
        itensSalvos.push(item);
        
        // Salvar no localStorage
        localStorage.setItem('calculadoraLucro', JSON.stringify(itensSalvos));
        
        // Atualizar dashboard
        atualizarDashboard();
        
        // Recarregar lista de itens
        carregarItensSalvos();
        
        // Limpar formul√°rio
        document.getElementById('nomeProduto').value = '';
        document.getElementById('custoDolar').value = '';
        document.getElementById('margemLucro').value = '';
        document.getElementById('quantidade').value = '1';
        document.getElementById('observacoes').value = '';
        
        // Limpar imagem do produto
        imagemProduto = null;
        imagemBase64 = null;
        document.getElementById('produtoImagem').value = '';
        document.getElementById('previewImagem').style.backgroundImage = '';
        document.getElementById('previewImagem').style.display = 'none';
        document.getElementById('removerImagemBtn').style.display = 'none';
        
        // Ocultar resultado
        document.getElementById('resultado').style.display = 'none';
        
        mostrarNotificacao('Or√ßamento salvo com sucesso!');
        
        // Se o usu√°rio estiver logado e o Firebase estiver configurado, salvar na nuvem
        if (usuarioAtual && firebase.apps.length > 0) {
            salvarItemNaNuvem(item, usuarioAtual.uid);
        }
    }
    
    // Modificar a fun√ß√£o exibirItensCardHTML para mostrar a imagem
    function exibirItensCardHTML(itensSalvos, itensSalvosDiv) {
        itensSalvosDiv.innerHTML = '';
        
        itensSalvos.forEach(item => {
            const quantidade = item.quantidade || 1;
            const metodoPagamento = item.metodoPagamento === 'pix' ? 'Pix' : 'Cart√£o de Cr√©dito';
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            
            // Preparar HTML da imagem
            const imagemHTML = item.imagem ? 
                `<div class="item-image" style="background-image: url('${item.imagem}');"></div>` : 
                `<div class="item-image"><i class="fas fa-image no-image"></i></div>`;
            
            itemDiv.innerHTML = `
                ${imagemHTML}
                <h4>${item.nomeProduto}</h4>
                <div class="item-details">
                    <p><strong>Data:</strong> ${formatarData(item.dataCotacao)}</p>
                    <p><strong>Custo em D√≥lar:</strong> ${formatarMoeda(item.custoDolar, 'USD')} (Cota√ß√£o ${formatarMoeda(item.cotacaoDolar, 'BRL')})</p>
                    <p><strong>Margem de Lucro Desejada:</strong> ${item.margemLucro}%</p>
                    <p><strong>M√©todo de Pagamento:</strong> ${metodoPagamento}</p>
                    <p><strong>Pre√ßo Unit√°rio:</strong> ${formatarMoeda(item.precoFinal, 'BRL')}</p>
                    <p><strong>Quantidade:</strong> ${quantidade} unidades</p>
                    <p><strong>Pre√ßo Total:</strong> ${formatarMoeda(item.precoFinal * quantidade, 'BRL')}</p>
                    <p><strong>Lucro Real:</strong> ${formatarMoeda(item.lucroReal || 0, 'BRL')} (${(item.percentualLucroReal || 0).toFixed(2)}%)</p>
                    ${item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : ''}
                    ${item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : ''}
                </div>
                <div class="item-actions">
                    <button class="edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Editar</button>
                    <button class="share-btn" data-id="${item.id}" style="background-color: #4895ef;"><i class="fas fa-share-alt"></i> Compartilhar</button>
                    <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Excluir</button>
                </div>
            `;
            itensSalvosDiv.appendChild(itemDiv);
        });
    }
    
    // Modificar a fun√ß√£o abrirModalCompartilhar para incluir a imagem
    function abrirModalCompartilhar(item) {
        const modal = document.getElementById('shareModal');
        const shareContent = document.getElementById('shareContent');
        
        const cliente = item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : '';
        const observacoes = item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : '';
        
        // Incluir imagem no modal se dispon√≠vel
        const imagemHTML = item.imagem ? 
            `<div class="share-image" style="background-image: url('${item.imagem}');"></div>` : '';
        
        // Preencher conte√∫do do modal
        shareContent.innerHTML = `
            <div style="margin-bottom: 20px;">
                ${imagemHTML}
                <h4 style="margin-bottom: 10px;">${item.nomeProduto}</h4>
                <p><strong>Pre√ßo Unit√°rio:</strong> ${formatarMoeda(item.precoFinal, 'BRL')}</p>
                <p><strong>Quantidade:</strong> ${item.quantidade || 1} unidades</p>
                <p><strong>Pre√ßo Total:</strong> ${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}</p>
                ${cliente}
                ${observacoes}
            </div>
        `;
        
        // Armazenar o item atual para compartilhamento
        window.itemParaCompartilhar = item;
        
        // Exibir modal
        modal.style.display = 'block';
    }
    
    // Modificar a fun√ß√£o editarItem para carregar a imagem
    function editarItem(id) {
        // Obter itens salvos
        const itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Encontrar item pelo id
        const item = itensSalvos.find(item => item.id == id);
        
        if (!item) {
            mostrarNotificacao('Item n√£o encontrado!', 'error');
            return;
        }
        
        // Mudar para a aba da calculadora
        document.querySelector('.tab-button[data-tab="calculator"]').click();
        
        // Preencher formul√°rio com dados do item
        document.getElementById('nomeProduto').value = item.nomeProduto;
        document.getElementById('dataCotacao').value = item.dataCotacao;
        document.getElementById('custoDolar').value = item.custoDolar;
        document.getElementById('cotacaoDolar').value = item.cotacaoDolar;
        document.getElementById('margemLucro').value = item.margemLucro;
        document.getElementById('quantidade').value = item.quantidade || 1;
        document.getElementById('observacoes').value = item.observacoes || '';
        
        // Carregar imagem se dispon√≠vel
        if (item.imagem) {
            imagemBase64 = item.imagem;
            document.getElementById('previewImagem').style.backgroundImage = `url('${item.imagem}')`;
            document.getElementById('previewImagem').style.display = 'block';
            document.getElementById('removerImagemBtn').style.display = 'block';
        } else {
            imagemBase64 = null;
            document.getElementById('previewImagem').style.backgroundImage = '';
            document.getElementById('previewImagem').style.display = 'none';
            document.getElementById('removerImagemBtn').style.display = 'none';
        }
        
        if (item.metodoPagamento) {
            document.getElementById('metodoPagamento').value = item.metodoPagamento;
            toggleTaxaDisplay(); // Atualizar exibi√ß√£o de taxas
        }
        
        if (item.clienteId) {
            document.getElementById('clienteSelect').value = item.clienteId;
        }
        
        // Rolar para o formul√°rio
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        
        // Calcular pre√ßo para mostrar resultado
        calcularPreco();
        
        // Pegar o bot√£o de salvar que foi criado ao calcular o pre√ßo
        const salvarBtn = document.getElementById('salvarBtn');
        
        // Atualizar texto e evento do bot√£o
        salvarBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Edi√ß√£o';
        
        // Remover eventos anteriores (clonar e substituir o bot√£o)
        const novoSalvarBtn = salvarBtn.cloneNode(true);
        salvarBtn.parentNode.replaceChild(novoSalvarBtn, salvarBtn);
        
        // Adicionar novo evento
        novoSalvarBtn.addEventListener('click', function() {
            // Remover item antigo
            excluirItem(id, false);
            
            // Salvar como novo item
            salvarItem(window.calculoAtual);
            
            mostrarNotificacao('Or√ßamento atualizado com sucesso!');
        });
    }
    
    // Modificar a fun√ß√£o compartilharPDF para incluir a imagem
    function compartilharPDF() {
        const item = window.itemParaCompartilhar;
        
        if (!item) return;
        
        // Preparar conte√∫do para PDF
        const content = document.createElement('div');
        
        // Incluir imagem se dispon√≠vel
        const imagemHTML = item.imagem ? 
            `<div style="width: 100%; height: 200px; background-image: url('${item.imagem}'); background-size: contain; background-position: center; background-repeat: no-repeat; margin-bottom: 20px;"></div>` : '';
        
        content.innerHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="color: #0d838c; text-align: center;">LED LINE BR PARTS</h1>
                <h2 style="text-align: center;">Or√ßamento</h2>
                
                <div style="margin-top: 30px;">
                    ${imagemHTML}
                    <h3 style="color: #0d838c;">${item.nomeProduto}</h3>
                    <p><strong>Data:</strong> ${formatarData(item.dataCotacao)}</p>
                    ${item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Item</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Valor</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Custo em D√≥lar</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.custoDolar, 'USD')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Cota√ß√£o do D√≥lar</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.cotacaoDolar, 'BRL')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Pre√ßo Unit√°rio</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.precoFinal, 'BRL')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Quantidade</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${item.quantidade || 1} unidades</td>
                        </tr>
                        <tr style="font-weight: bold; background-color: #f2f2f2;">
                            <td style="padding: 10px; border: 1px solid #ddd;">Pre√ßo Total</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}</td>
                        </tr>
                    </table>
                    
                    ${item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : ''}
                    
                    <div style="margin-top: 30px; font-size: 12px; color: #666; text-align: center;">
                        <p>Or√ßamento gerado em ${formatarData(new Date().toISOString())}</p>
                        <p>LED LINE BR PARTS</p>
                    </div>
                </div>
            </div>
        `;
        
        // Colocar elemento na p√°gina temporariamente
        document.body.appendChild(content);
        
        // Usar html2canvas e jsPDF para gerar PDF
        html2canvas(content).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`orcamento_${item.nomeProduto.replace(/\s+/g, '_')}.pdf`);
            
            // Remover elemento tempor√°rio
            document.body.removeChild(content);
            
            // Fechar modal
            document.getElementById('shareModal').style.display = 'none';
        });
    }
</script>
    // Vari√°veis e configura√ß√µes globais
    let currentChart = null;
    let cotacaoChart = null;
    let paymentMethodChart = null;
    let monthlyBudgetChart = null;
    let cotacaoHistorico = [];
    let clientesData = [];
    let usuarioAtual = null;
    let deferredPrompt = null;
    
    // Firebase config - SUBSTITUA COM SUAS CREDENCIAIS DO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBCIzlpkVhBvum-tdZ0l_bNPq6ooKY_Utk",
        authDomain: "calculadora-led-line-ff960.firebaseapp.com",
        projectId: "calculadora-led-line-ff960",
        storageBucket: "calculadora-led-line-ff960.firebasestorage.app", 
        messagingSenderId: "840987995786",
        appId: "1:840987995786:web:a1f2a8e0daf10aee310773"
     measurementId: "G-5T82RDCD9F"
    };
    
    // Inicializa√ß√£o quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializa√ß√£o do Firebase (descomente quando tiver suas credenciais)
    
    firebase.initializeApp(firebaseConfig);
        
        // Configurar sistema de abas
        setupTabs();
        
        // Definir data atual no campo de data
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dataCotacao').value = today;
        
        // Inicializar configura√ß√µes
        initConfig();
        
        // Buscar cota√ß√£o do d√≥lar atual
        atualizarCotacaoDolar();
        
        // Carregar hist√≥rico de cota√ß√µes
        carregarHistoricoCotacao();
        
        // Carregar itens salvos
        carregarItensSalvos();
        
        // Carregar clientes
        carregarClientes();
        
        // Atualizar dashboard
        atualizarDashboard();
        
        // Adicionar eventos aos bot√µes
        addEventListeners();
        
        // Verificar compatibilidade offline
        verificarCompatibilidadeOffline();
        
        // Configurar monitoramento de conex√£o
        configurarMonitorConexao();
        
        // Verificar se a aplica√ß√£o est√° sendo executada como PWA
        verificarPWA();
    });
    
    // Configurar sistema de abas
    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // Desativar todas as abas
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Ativar a aba selecionada
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Atualizar gr√°ficos espec√≠ficos da aba
                if (tabId === 'history') {
                    atualizarGraficoCotacao();
                } else if (tabId === 'dashboard') {
                    atualizarDashboard();
                }
            });
        });
    }
    
    // Adicionar todos os event listeners
    function addEventListeners() {
        // Bot√µes da calculadora
        document.getElementById('calcularBtn').addEventListener('click', calcularPreco);
        document.getElementById('calcularLucroBtn').addEventListener('click', calcularLucroDoValor);
        document.getElementById('editarTaxasBtn').addEventListener('click', toggleTaxasForm);
        document.getElementById('salvarTaxasBtn').addEventListener('click', salvarTaxas);
        document.getElementById('theme-toggle').addEventListener('change', function() {
            toggleTheme();
            atualizarTemaGraficos();
        });
        document.getElementById('atualizarDolarBtn').addEventListener('click', atualizarCotacaoDolar);
        document.getElementById('metodoPagamento').addEventListener('change', toggleTaxaDisplay);
        document.getElementById('addClienteBtn').addEventListener('click', abrirModalCliente);
        
        // Bot√µes de or√ßamentos salvos
        document.getElementById('buscarBtn').addEventListener('click', filtrarOrcamentos);
        document.getElementById('filtroOrcamentos').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                filtrarOrcamentos();
            }
        });
        document.getElementById('exportarCSVBtn').addEventListener('click', exportarCSV);
        document.getElementById('exportarExcelBtn').addEventListener('click', exportarExcel);
        document.getElementById('limparDadosBtn').addEventListener('click', limparDados);
        document.getElementById('cardViewBtn').addEventListener('click', function() {
            setActiveViewButton('cardViewBtn');
            carregarItensSalvos('card');
        });
        document.getElementById('tableViewBtn').addEventListener('click', function() {
            setActiveViewButton('tableViewBtn');
            carregarItensSalvos('table');
        });
        
        // Bot√µes de clientes
        document.getElementById('newClientBtn').addEventListener('click', abrirModalCliente);
        document.getElementById('saveClientBtn').addEventListener('click', salvarCliente);
        document.getElementById('buscarClientesBtn').addEventListener('click', filtrarClientes);
        
        // Bot√µes de alerta de cota√ß√£o
        document.getElementById('setAlertaBtn').addEventListener('click', definirAlertaCotacao);
        
        // Bot√µes de login
        document.getElementById('loginStatusBtn').addEventListener('click', abrirModalLogin);
        document.getElementById('loginBtn').addEventListener('click', fazerLogin);
        document.getElementById('registerBtn').addEventListener('click', registrarUsuario);
        
        // Bot√µes de compartilhamento
        document.getElementById('shareWhatsapp').addEventListener('click', compartilharWhatsApp);
        document.getElementById('shareEmail').addEventListener('click', compartilharEmail);
        document.getElementById('sharePdf').addEventListener('click', compartilharPDF);
        document.getElementById('shareLink').addEventListener('click', compartilharLink);
        
        // Bot√£o de instala√ß√£o PWA
        document.getElementById('installBtn').addEventListener('click', instalarPWA);
        
        // Fechar modais
        document.querySelectorAll('.close-modal').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        // Fechar modais ao clicar fora
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
        
        // Eventos de conex√£o
        window.addEventListener('online', function() {
            mostrarStatusConexao(true);
            // Tentar sincronizar dados
            if (usuarioAtual && firebase.apps.length > 0) {
                sincronizarDados();
            }
        });
        
        window.addEventListener('offline', function() {
            mostrarStatusConexao(false);
        });
    }
    
    // Configurar monitoramento de conex√£o
    function configurarMonitorConexao() {
        // Mostrar status inicial
        mostrarStatusConexao(navigator.onLine);
        
        // Verificar periodicamente a conex√£o (cada 30 segundos)
        setInterval(function() {
            fetch('https://www.google.com/favicon.ico', { 
                mode: 'no-cors',
                cache: 'no-store'
            })
            .then(() => mostrarStatusConexao(true))
            .catch(() => mostrarStatusConexao(false));
        }, 30000);
    }
    
    // Mostrar status de conex√£o
    function mostrarStatusConexao(online) {
        const statusEl = document.getElementById('connectionStatus');
        
        if (online) {
            statusEl.textContent = 'Online';
            statusEl.className = 'connection-status online';
            
            // Mostrar por 3 segundos e depois esconder
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        } else {
            statusEl.textContent = 'Offline - Modo Local';
            statusEl.className = 'connection-status offline';
            statusEl.style.display = 'block';
        }
    }
    
    // Verificar se est√° sendo executado como PWA
    function verificarPWA() {
        const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                                 window.navigator.standalone || document.referrer.includes('android-app://');
                                 
        if (!isInStandaloneMode) {
            // Capturar evento para mostrar o banner de instala√ß√£o
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevenir comportamento padr√£o
                e.preventDefault();
                // Armazenar o evento para uso posterior
                deferredPrompt = e;
                // Mostrar banner de instala√ß√£o
                document.getElementById('installBanner').style.display = 'flex';
            });
        }
    }
    
    // Instalar PWA
    function instalarPWA() {
        if (deferredPrompt) {
            // Mostrar prompt de instala√ß√£o
            deferredPrompt.prompt();
            
            // Aguardar a escolha do usu√°rio
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usu√°rio aceitou a instala√ß√£o');
                    mostrarNotificacao('Aplica√ß√£o instalada com sucesso!');
                } else {
                    console.log('Usu√°rio recusou a instala√ß√£o');
                }
                
                // Limpar a vari√°vel, s√≥ pode ser usada uma vez
                deferredPrompt = null;
                
                // Esconder banner
                document.getElementById('installBanner').style.display = 'none';
            });
        }
    }
    
    // Verificar compatibilidade offline
    function verificarCompatibilidadeOffline() {
        // Verificar se Storage est√° dispon√≠vel
        const storageDisponivel = (function() {
            try {
                localStorage.setItem('teste', 'teste');
                localStorage.removeItem('teste');
                return true;
            } catch (e) {
                return false;
            }
        })();

        if (!storageDisponivel) {
            alert('Seu navegador n√£o suporta armazenamento local. Algumas funcionalidades podem n√£o funcionar corretamente.');
        }
        
        // Verificar Service Worker
        if (!('serviceWorker' in navigator)) {
            console.warn('Service Worker n√£o suportado. Funcionalidade offline limitada.');
        }
    }
    
    // Alternar exibi√ß√£o do formul√°rio de taxas
    function toggleTaxasForm() {
        const taxasForm = document.getElementById('taxasForm');
        taxasForm.style.display = taxasForm.style.display === 'block' ? 'none' : 'block';
    }
    
    // Alternar exibi√ß√£o de taxas com base no m√©todo de pagamento
    function toggleTaxaDisplay() {
        const metodoPagamento = document.getElementById('metodoPagamento').value;
        
        if (metodoPagamento === 'pix') {
            document.getElementById('taxaCartaoItem').style.display = 'none';
            document.getElementById('taxaPixItem').style.display = 'list-item';
        } else {
            document.getElementById('taxaCartaoItem').style.display = 'list-item';
            document.getElementById('taxaPixItem').style.display = 'none';
        }
    }
    
    // Inicializar configura√ß√µes
    function initConfig() {
        // Carregar taxas do localStorage ou usar valores padr√£o
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
            taxas: {
                parcelamento: 14.35,
                pix: 0.79,
                yampi: 2.5,
                imposto: 10
            },
            tema: 'light',
            visualizacao: 'card',
            alertas: []
        };
        
        // Atualizar campos com taxas salvas
        document.getElementById('taxaParcelamento').value = config.taxas.parcelamento;
        document.getElementById('taxaPix').value = config.taxas.pix || 0.79;
        document.getElementById('taxaYampi').value = config.taxas.yampi;
        document.getElementById('taxaImposto').value = config.taxas.imposto;
        
        // Atualizar display de taxas
        document.getElementById('taxaParcelamentoDisplay').textContent = config.taxas.parcelamento;
        document.getElementById('taxaPixDisplay').textContent = config.taxas.pix || 0.79;
        document.getElementById('taxaYampiDisplay').textContent = config.taxas.yampi;
        document.getElementById('taxaImpostoDisplay').textContent = config.taxas.imposto;
        
        // Configurar tema
        if (config.tema === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('theme-toggle').checked = true;
        }
        
        return config;
    }
    
    // Salvar taxas personalizadas
    function salvarTaxas() {
        const taxaParcelamento = parseFloat(document.getElementById('taxaParcelamento').value);
        const taxaPix = parseFloat(document.getElementById('taxaPix').value);
        const taxaYampi = parseFloat(document.getElementById('taxaYampi').value);
        const taxaImposto = parseFloat(document.getElementById('taxaImposto').value);
        
        // Validar inputs
        if (isNaN(taxaParcelamento) || isNaN(taxaPix) || isNaN(taxaYampi) || isNaN(taxaImposto)) {
            mostrarNotificacao('Por favor, preencha todas as taxas corretamente.', 'error');
            return;
        }
        
        // Carregar configura√ß√£o atual
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
            taxas: {},
            tema: 'light',
            visualizacao: 'card',
            alertas: []
        };
        
        // Atualizar taxas
        config.taxas = {
            parcelamento: taxaParcelamento,
            pix: taxaPix,
            yampi: taxaYampi,
            imposto: taxaImposto
        };
        
        // Salvar configura√ß√£o
        localStorage.setItem('calculadoraConfig', JSON.stringify(config));
        
        // Atualizar display
        document.getElementById('taxaParcelamentoDisplay').textContent = taxaParcelamento;
        document.getElementById('taxaPixDisplay').textContent = taxaPix;
        document.getElementById('taxaYampiDisplay').textContent = taxaYampi;
        document.getElementById('taxaImpostoDisplay').textContent = taxaImposto;
        
        // Esconder formul√°rio
        document.getElementById('taxasForm').style.display = 'none';
        
        mostrarNotificacao('Taxas atualizadas com sucesso!');
    }
    
    // Alternar tema claro/escuro
    function toggleTheme() {
        const isChecked = document.getElementById('theme-toggle').checked;
        const tema = isChecked ? 'dark' : 'light';
        
        // Aplicar tema
        document.body.setAttribute('data-theme', tema);
        
        // Salvar prefer√™ncia
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
            taxas: {
                parcelamento: 14.35,
                pix: 0.79,
                yampi: 2.5,
                imposto: 10
            },
            visualizacao: 'card',
            alertas: []
        };
        
        config.tema = tema;
        localStorage.setItem('calculadoraConfig', JSON.stringify(config));
    }
    
    // Atualizar tema para os gr√°ficos
    function atualizarTemaGraficos() {
        const tema = document.body.getAttribute('data-theme');
        const corTexto = tema === 'dark' ? '#f0f0f0' : '#212529';
        
        // Atualizar op√ß√µes de todos os gr√°ficos
        const atualizarOpcoesGraficos = (chart) => {
            if (!chart) return;
            
            // Atualizar cores do texto
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels.color = corTexto;
            }
            
            if (chart.options.scales) {
                if (chart.options.scales.x) {
                    chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
                    chart.options.scales.x.ticks.color = corTexto;
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
                    chart.options.scales.y.ticks.color = corTexto;
                }
            }
            
            chart.update();
        };
        
        // Atualizar todos os gr√°ficos
        if (currentChart) atualizarOpcoesGraficos(currentChart);
        if (cotacaoChart) atualizarOpcoesGraficos(cotacaoChart);
        if (paymentMethodChart) atualizarOpcoesGraficos(paymentMethodChart);
        if (monthlyBudgetChart) atualizarOpcoesGraficos(monthlyBudgetChart);
    }
    
    // Fun√ß√£o melhorada para atualiza√ß√£o da cota√ß√£o do d√≥lar
    async function atualizarCotacaoDolar() {
        try {
            // Mostrar um loader no campo de cota√ß√£o
            const cotacaoInput = document.getElementById('cotacaoDolar');
            const atualizarBtn = document.getElementById('atualizarDolarBtn');
            const oldValue = cotacaoInput.value;
            
            cotacaoInput.value = "Carregando...";
            cotacaoInput.disabled = true;
            atualizarBtn.innerHTML = '<span class="loader"></span>';
            atualizarBtn.disabled = true;
            
            // Fazer requisi√ß√£o para a API de cota√ß√£o
            const response = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
            const data = await response.json();
            
            // Extrair o valor da cota√ß√£o
            if (data && data.USDBRL && data.USDBRL.bid) {
                const cotacao = parseFloat(data.USDBRL.bid);
                
                // Atualizar campo com o valor atual
                cotacaoInput.value = cotacao.toFixed(2);
                
                // Salvar cota√ß√£o no hist√≥rico
                salvarCotacaoHistorico(cotacao);
                
                // Verificar alertas de cota√ß√£o
                verificarAlertasCotacao(cotacao);
                
                mostrarNotificacao('Cota√ß√£o do d√≥lar atualizada!');
            } else {
                throw new Error('Formato de resposta inv√°lido');
            }
        } catch (error) {
            console.error('Erro ao buscar cota√ß√£o do d√≥lar:', error);
            
            // Restaurar valor anterior ou definir um valor padr√£o
            document.getElementById('cotacaoDolar').value = oldValue || "5.00";
            
            // Usar uma API alternativa como fallback
            try {
                const fallbackResponse = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const fallbackData = await fallbackResponse.json();
                if (fallbackData && fallbackData.rates && fallbackData.rates.BRL) {
                    document.getElementById('cotacaoDolar').value = fallbackData.rates.BRL.toFixed(2);
                    mostrarNotificacao('Cota√ß√£o atualizada com fonte alternativa.');
                } else {
                    mostrarNotificacao('Erro ao atualizar cota√ß√£o. Tente novamente ou insira manualmente.', 'error');
                }
            } catch (fallbackError) {
                mostrarNotificacao('Erro ao atualizar cota√ß√£o. Tente novamente ou insira manualmente.', 'error');
            }
        } finally {
            // Restaurar bot√£o e input independente do resultado
            document.getElementById('cotacaoDolar').disabled = false;
            document.getElementById('atualizarDolarBtn').innerHTML = '<i class="fas fa-sync-alt"></i>';
            document.getElementById('atualizarDolarBtn').disabled = false;
        }
    }
    
    // Salvar cota√ß√£o no hist√≥rico
    function salvarCotacaoHistorico(cotacao) {
        let historico = JSON.parse(localStorage.getItem('cotacaoHistorico')) || [];
        
        // Adicionar cota√ß√£o atual
        historico.push({
            data: new Date().toISOString(),
            valor: cotacao
        });
        
        // Manter apenas os √∫ltimos 30 dias
        if (historico.length > 30) {
            historico = historico.slice(historico.length - 30);
        }
        
        // Salvar no localStorage
        localStorage.setItem('cotacaoHistorico', JSON.stringify(historico));
        
        // Atualizar vari√°vel global
        cotacaoHistorico = historico;
    }
    
    // Carregar hist√≥rico de cota√ß√µes
    function carregarHistoricoCotacao() {
        const historico = JSON.parse(localStorage.getItem('cotacaoHistorico')) || [];
        cotacaoHistorico = historico;
    }
    
    // Atualizar gr√°fico de cota√ß√£o
    function atualizarGraficoCotacao() {
        const ctx = document.getElementById('cotacaoChart').getContext('2d');
        
        // Formatar dados para o gr√°fico
        const labels = cotacaoHistorico.map(item => {
            const data = new Date(item.data);
            return `${data.getDate()}/${data.getMonth() + 1}`;
        });
        
        const valores = cotacaoHistorico.map(item => item.valor);
        
        // Destruir gr√°fico anterior se existir
        if (cotacaoChart) {
            cotacaoChart.destroy();
        }
        
        // Determinar cor do texto com base no tema
        const tema = document.body.getAttribute('data-theme');
        const corTexto = tema === 'dark' ? '#f0f0f0' : '#212529';
        
        // Criar novo gr√°fico
        cotacaoChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cota√ß√£o do D√≥lar (R$)',
                    data: valores,
                    backgroundColor: 'rgba(13, 131, 140, 0.2)',
                    borderColor: 'rgba(13, 131, 140, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: corTexto,
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    },
                    x: {
                        ticks: {
                            color: corTexto
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: corTexto
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'R$ ' + context.raw.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        
        // Mostrar alertas ativos
        mostrarAlertasAtivos();
    }
    
    // Definir alerta de cota√ß√£o
    function definirAlertaCotacao() {
        const valorAlerta = parseFloat(document.getElementById('alertaValor').value);
        
        if (isNaN(valorAlerta) || valorAlerta <= 0) {
            mostrarNotificacao('Por favor, insira um valor v√°lido para o alerta.', 'error');
            return;
        }
        
        // Carregar configura√ß√£o atual
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
            taxas: {
                parcelamento: 14.35,
                pix: 0.79,
                yampi: 2.5,
                imposto: 10
            },
            tema: 'light',
            visualizacao: 'card',
            alertas: []
        };
        
        // Adicionar novo alerta
        config.alertas = config.alertas || [];
        
        // Verificar se j√° existe um alerta com esse valor
        const alertaExistente = config.alertas.find(a => a.valor === valorAlerta);
        
        if (alertaExistente) {
            mostrarNotificacao('J√° existe um alerta com esse valor.', 'error');
            return;
        }
        
        config.alertas.push({
            id: Date.now(),
            valor: valorAlerta,
            dataDefinicao: new Date().toISOString(),
            ativo: true
        });
        
        // Salvar configura√ß√£o
        localStorage.setItem('calculadoraConfig', JSON.stringify(config));
        
        // Atualizar UI
        mostrarAlertasAtivos();
        document.getElementById('alertaValor').value = '';
        
        mostrarNotificacao(`Alerta definido para R$ ${valorAlerta.toFixed(2)}`);
    }
    
    // Mostrar alertas ativos
    function mostrarAlertasAtivos() {
        const alertasContainer = document.getElementById('alertasAtivos');
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {};
        const alertas = config.alertas || [];
        
        if (alertas.length === 0) {
            alertasContainer.innerHTML = '<p>Nenhum alerta definido.</p>';
            return;
        }
        
        let html = '<h5>Alertas ativos:</h5><ul style="list-style-type: none; padding: 0;">';
        
        alertas.forEach(alerta => {
            html += `
                <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0; border-bottom: 1px solid var(--gray-light);">
                    <div>
                        <span class="badge ${alerta.ativo ? 'badge-primary' : 'badge-warning'}">${alerta.ativo ? 'Ativo' : 'Pausado'}</span>
                        R$ ${alerta.valor.toFixed(2)}
                    </div>
                    <div>
                        <button class="btn-small" style="background-color: #6c757d;" onclick="removerAlerta(${alerta.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `;
        });
        
        html += '</ul>';
        alertasContainer.innerHTML = html;
    }
    
    // Remover alerta
    function removerAlerta(id) {
        // Carregar configura√ß√£o atual
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {};
        
        // Filtrar alertas
        config.alertas = (config.alertas || []).filter(a => a.id !== id);
        
        // Salvar configura√ß√£o
        localStorage.setItem('calculadoraConfig', JSON.stringify(config));
        
        // Atualizar UI
        mostrarAlertasAtivos();
        
        mostrarNotificacao('Alerta removido com sucesso.');
    }
    
    // Verificar alertas de cota√ß√£o
    function verificarAlertasCotacao(cotacaoAtual) {
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {};
        const alertas = config.alertas || [];
        
        // Verificar cada alerta
        alertas.forEach(alerta => {
            if (alerta.ativo) {
                // Para alertas de valor mais baixo, notifica quando a cota√ß√£o cai abaixo
                // Para alertas de valor mais alto, notifica quando a cota√ß√£o sobe acima
                const cotacaoAnterior = cotacaoHistorico.length > 1 ? cotacaoHistorico[cotacaoHistorico.length - 2]?.valor : null;
                
                if (cotacaoAnterior !== null) {
                    if (cotacaoAnterior < alerta.valor && cotacaoAtual >= alerta.valor) {
                        // Cota√ß√£o subiu e passou do valor do alerta
                        mostrarNotificacao(`Alerta: D√≥lar atingiu R$ ${cotacaoAtual.toFixed(2)}`, 'warning');
                        
                        // Tentar enviar notifica√ß√£o do navegador
                        enviarNotificacao("Alerta de Cota√ß√£o", `D√≥lar atingiu R$ ${cotacaoAtual.toFixed(2)}`);
                    } else if (cotacaoAnterior > alerta.valor && cotacaoAtual <= alerta.valor) {
                        // Cota√ß√£o caiu e passou do valor do alerta
                        mostrarNotificacao(`Alerta: D√≥lar caiu para R$ ${cotacaoAtual.toFixed(2)}`, 'warning');
                        
                        // Tentar enviar notifica√ß√£o do navegador
                        enviarNotificacao("Alerta de Cota√ß√£o", `D√≥lar caiu para R$ ${cotacaoAtual.toFixed(2)}`);
                    }
                }
            }
        });
    }
    
    // Enviar notifica√ß√£o do navegador
    function enviarNotificacao(titulo, mensagem) {
        // Verificar se notifica√ß√µes s√£o suportadas e permitidas
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                new Notification(titulo, { 
                    body: mensagem,
                    icon: 'icon-192.png'
                });
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification(titulo, { 
                            body: mensagem,
                            icon: 'icon-192.png'
                        });
                    }
                });
            }
        }
    }
    
    // Formatar data
    function formatarData(dataString) {
        if (!dataString) return '-';
        
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return dataString; // Se a data for inv√°lida, retorna a string original
        
        return data.toLocaleDateString('pt-BR');
    }
    
    // Melhoria na fun√ß√£o de c√°lculo para evitar valores NaN ou undefined
    function calcularPreco() {
        // Obter valores dos campos
        const nomeProduto = document.getElementById('nomeProduto').value.trim();
        const dataCotacao = document.getElementById('dataCotacao').value;
        const custoDolar = parseFloat(document.getElementById('custoDolar').value) || 0;
        const cotacaoDolar = parseFloat(document.getElementById('cotacaoDolar').value) || 0;
        const margemLucro = parseFloat(document.getElementById('margemLucro').value) || 0;
        const quantidade = parseInt(document.getElementById('quantidade').value) || 1;
        const metodoPagamento = document.getElementById('metodoPagamento').value;
        const clienteId = document.getElementById('clienteSelect').value;
        const observacoes = document.getElementById('observacoes').value;
        
        // Validar inputs
        if (!nomeProduto || !dataCotacao || custoDolar <= 0 || cotacaoDolar <= 0 || margemLucro < 0) {
            mostrarNotificacao('Por favor, preencha todos os campos obrigat√≥rios corretamente.', 'error');
            return;
        }
        
        // Obter taxas personalizadas
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
            taxas: {
                parcelamento: 14.35,
                pix: 0.79,
                yampi: 2.5,
                imposto: 10
            }
        };
        
        // Calcular custo em reais
        const custoReais = custoDolar * cotacaoDolar;
        
        // Calcular pre√ßo com margem de lucro
        const precoComMargem = custoReais * (1 + margemLucro / 100);
        
        // Selecionar a taxa de pagamento correta com base no m√©todo
let taxaPagamento, nomeTaxaPagamento;
let precoFinal;
let descontoPix = false;

if (metodoPagamento === 'pix') {
    // Para PIX: primeiro calculamos como se fosse cart√£o (14.35%) e depois aplicamos 5% de desconto
    taxaPagamento = config.taxas.parcelamento / 100;
    nomeTaxaPagamento = `Taxa cart√£o para c√°lculo (${config.taxas.parcelamento}%)`;
    descontoPix = true;
} else {
    taxaPagamento = config.taxas.parcelamento / 100;
    nomeTaxaPagamento = `Parcelamento sem juros (${config.taxas.parcelamento}%)`;
}
        }
        
        // Calcular valores individuais das taxas
        const valorTaxaPagamento = precoFinal * taxaPagamento;
        const valorYampi = precoFinal * taxaYampi;
        const valorImposto = precoFinal * taxaImposto;
        
        // Calcular custo do produto com as taxas
        const custoProdutoComTaxas = custoReais / (1 - totalTaxas);
        
        // Calcular valor do lucro e percentual
        const lucroReal = precoFinal - custoProdutoComTaxas;
        const percentualLucroReal = (lucroReal / custoProdutoComTaxas) * 100;
        
        // Calcular valores totais para m√∫ltiplas unidades
        const custoTotalReais = custoReais * quantidade;
        const precoTotalFinal = precoFinal * quantidade;
        const lucroTotalReal = lucroReal * quantidade;
        
        // Exibir resultado
        const resultadoDiv = document.getElementById('resultado');
        const resultadoDetalhes = document.getElementById('resultadoDetalhes');
        
        resultadoDetalhes.innerHTML = `
            <p><strong>Nome do Produto:</strong> ${nomeProduto}</p>
            <p><strong>Data da Cota√ß√£o:</strong> ${formatarData(dataCotacao)}</p>
            <p><strong>Custo em D√≥lar:</strong> ${formatarMoeda(custoDolar, 'USD')}</p>
            <p><strong>Cota√ß√£o do D√≥lar:</strong> ${formatarMoeda(cotacaoDolar, 'BRL')}</p>
            <p><strong>Custo em Reais:</strong> ${formatarMoeda(custoReais, 'BRL')}</p>
            <p><strong>Margem de Lucro Desejada:</strong> ${margemLucro}%</p>
            <p><strong>Pre√ßo com Margem:</strong> ${formatarMoeda(precoComMargem, 'BRL')}</p>
            <hr>
            <p><strong>Taxas Aplicadas:</strong></p>
            <ul>
                <li><span>${nomeTaxaPagamento}:</span> <span>${formatarMoeda(valorTaxaPagamento, 'BRL')}</span></li>
                <li><span>Yampi (${config.taxas.yampi}%):</span> <span>${formatarMoeda(valorYampi, 'BRL')}</span></li>
                <li><span>Imposto (${config.taxas.imposto}%):</span> <span>${formatarMoeda(valorImposto, 'BRL')}</span></li>
            </ul>
            <hr>
            <p><strong>Custo do Produto com Taxas:</strong> ${formatarMoeda(custoProdutoComTaxas, 'BRL')}</p>
            <p><strong>Valor do Lucro em Reais:</strong> ${formatarMoeda(lucroReal, 'BRL')}</p>
            <p><strong>Percentual de Lucro Real:</strong> ${percentualLucroReal.toFixed(2)}%</p>
            <hr>
            <p><strong>Pre√ßo Final Unit√°rio:</strong> ${formatarMoeda(precoFinal, 'BRL')}</p>
            <hr>
            <p><strong>Quantidade:</strong> ${quantidade} unidades</p>
            <p><strong>Custo Total:</strong> ${formatarMoeda(custoTotalReais, 'BRL')}</p>
            <p><strong>Lucro Total:</strong> ${formatarMoeda(lucroTotalReal, 'BRL')}</p>
            <p><strong>Pre√ßo Final Total:</strong> ${formatarMoeda(precoTotalFinal, 'BRL')}</p>
        `;
        
        resultadoDiv.style.display = 'block';
        
        // Criar gr√°fico
        criarGrafico(custoProdutoComTaxas, valorTaxaPagamento, valorYampi, valorImposto, lucroReal);
        
        // Armazenar dados do c√°lculo atual para compartilhamento e salvamento
        window.calculoAtual = {
            id: Date.now(),
            nomeProduto,
            dataCotacao,
            custoDolar,
            cotacaoDolar,
            margemLucro,
            custoReais,
            precoComMargem,
            valorTaxaPagamento,
            valorYampi,
            valorImposto,
            precoFinal,
            custoProdutoComTaxas,
            lucroReal,
            percentualLucroReal,
            quantidade,
            metodoPagamento,
            precoTotalFinal,
            clienteId,
            clienteNome: clienteId ? clientesData.find(c => c.id == clienteId)?.nome : '',
            observacoes,
            taxas: config.taxas,
            dataCriacao: new Date().toISOString()
        };
        
        // Remover eventos anteriores (clonar e substituir os bot√µes)
        const salvarBtn = document.getElementById('salvarBtn');
        const compartilharBtn = document.getElementById('compartilharBtn');
        
        const novoSalvarBtn = salvarBtn.cloneNode(true);
        const novoCompartilharBtn = compartilharBtn.cloneNode(true);
        
        salvarBtn.parentNode.replaceChild(novoSalvarBtn, salvarBtn);
        compartilharBtn.parentNode.replaceChild(novoCompartilharBtn, compartilharBtn);
        
        // Adicionar novos eventos
        novoSalvarBtn.addEventListener('click', function() {
            salvarItem(window.calculoAtual);
        });
        
        novoCompartilharBtn.addEventListener('click', function() {
            abrirModalCompartilhar(window.calculoAtual);
        });
        
        // Rolar para o resultado
        resultadoDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Criar gr√°fico de distribui√ß√£o
    function criarGrafico(custoProduto, taxaPagamento, taxaYampi, taxaImposto, lucro) {
        const ctx = document.getElementById('graficoDistribuicao').getContext('2d');
        
        // Destruir gr√°fico anterior se existir
        if (currentChart) {
            currentChart.destroy();
        }
        
        // Pegar m√©todo de pagamento para definir label
        const metodoPagamento = document.getElementById('metodoPagamento').value;
        const taxaLabel = metodoPagamento === 'pix' ? 'Taxa Pix' : 'Parcelamento';
        
        // Determinar cor do texto com base no tema
        const tema = document.body.getAttribute('data-theme');
        const corTexto = tema === 'dark' ? '#f0f0f0' : '#212529';
        
        // Criar novo gr√°fico
        currentChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Custo Base', taxaLabel, 'Yampi', 'Imposto', 'Lucro'],
                datasets: [{
                    data: [custoProduto, taxaPagamento, taxaYampi, taxaImposto, lucro],
                    backgroundColor: [
                        '#0d838c',
                        '#333333',
                        '#555555',
                        '#777777',
                        '#4cc9f0'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: corTexto
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(2) + '%';
                                return `${label}: ${formatarMoeda(value, 'BRL')} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Salvar item
    function salvarItem(item) {
        // Obter itens salvos do localStorage
        let itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Adicionar novo item
        itensSalvos.push(item);
        
        // Salvar no localStorage
        localStorage.setItem('calculadoraLucro', JSON.stringify(itensSalvos));
        
        // Atualizar dashboard
        atualizarDashboard();
        
        // Recarregar lista de itens
        carregarItensSalvos();
        
        // Limpar formul√°rio
        document.getElementById('nomeProduto').value = '';
        document.getElementById('custoDolar').value = '';
        document.getElementById('margemLucro').value = '';
        document.getElementById('quantidade').value = '1';
        document.getElementById('observacoes').value = '';
        
        // Ocultar resultado
        document.getElementById('resultado').style.display = 'none';
        
        mostrarNotificacao('Or√ßamento salvo com sucesso!');
        
        // Se o usu√°rio estiver logado e o Firebase estiver configurado, salvar na nuvem
        if (usuarioAtual && firebase.apps.length > 0) {
            salvarItemNaNuvem(item, usuarioAtual.uid);
        }
    }
    
    // Salvar item na nuvem (Firebase)
    async function salvarItemNaNuvem(item, userId) {
        try {
            // Adicionar identificador de usu√°rio ao item
            item.userId = userId;
            
            // Refer√™ncia ao Firestore
            const db = firebase.firestore();
            
            // Adicionar ao Firestore
            await db.collection('orcamentos').add(item);
            
            console.log('Item salvo na nuvem com sucesso!');
        } catch (error) {
            console.error('Erro ao salvar item na nuvem:', error);
            mostrarNotificacao('Or√ßamento salvo localmente, mas ocorreu um erro ao salvar na nuvem.', 'error');
        }
    }
    
    // Carregar itens salvos
    function carregarItensSalvos(viewType) {
        const itensSalvosDiv = document.getElementById('itensSalvos');
        let itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Carregar configura√ß√£o
        const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
            visualizacao: 'card'
        };
        
        // Usar visualiza√ß√£o salva ou a que foi passada
        const visualizacao = viewType || config.visualizacao;
        
        // Salvar prefer√™ncia de visualiza√ß√£o
        if (viewType) {
            config.visualizacao = viewType;
            localStorage.setItem('calculadoraConfig', JSON.stringify(config));
        }
        
        if (itensSalvos.length === 0) {
            itensSalvosDiv.innerHTML = '<p>Nenhum or√ßamento salvo ainda.</p>';
            return;
        }
        
        // Ordenar itens do mais recente para o mais antigo
        itensSalvos.sort((a, b) => b.id - a.id);
        
        // Verificar se h√° filtro ativo
        const filtro = document.getElementById('filtroOrcamentos').value.trim().toLowerCase();
        if (filtro) {
            itensSalvos = itensSalvos.filter(item => 
                item.nomeProduto.toLowerCase().includes(filtro) || 
                formatarMoeda(item.precoFinal, 'BRL').includes(filtro) ||
                (item.margemLucro + '%').includes(filtro) ||
                (item.clienteNome && item.clienteNome.toLowerCase().includes(filtro))
            );
        }
        
        // Exibir itens conforme o tipo de visualiza√ß√£o
        if (visualizacao === 'table') {
            exibirItensTabelaHTML(itensSalvos, itensSalvosDiv);
        } else {
            exibirItensCardHTML(itensSalvos, itensSalvosDiv);
        }
        
        // Adicionar eventos aos bot√µes
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editarItem(this.getAttribute('data-id'));
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                excluirItem(this.getAttribute('data-id'));
            });
        });
        
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.getAttribute('data-id');
                const item = itensSalvos.find(item => item.id == itemId);
                if (item) {
                    abrirModalCompartilhar(item);
                }
            });
        });
    }
    
    // Exibir itens em formato de cards
    function exibirItensCardHTML(itensSalvos, itensSalvosDiv) {
        itensSalvosDiv.innerHTML = '';
        
        itensSalvos.forEach(item => {
            const quantidade = item.quantidade || 1;
            const metodoPagamento = item.metodoPagamento === 'pix' ? 'Pix' : 'Cart√£o de Cr√©dito';
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            itemDiv.innerHTML = `
                <h4>${item.nomeProduto}</h4>
                <div class="item-details">
                    <p><strong>Data:</strong> ${formatarData(item.dataCotacao)}</p>
                    <p><strong>Custo em D√≥lar:</strong> ${formatarMoeda(item.custoDolar, 'USD')} (Cota√ß√£o ${formatarMoeda(item.cotacaoDolar, 'BRL')})</p>
                    <p><strong>Margem de Lucro Desejada:</strong> ${item.margemLucro}%</p>
                    <p><strong>M√©todo de Pagamento:</strong> ${metodoPagamento}</p>
                    <p><strong>Pre√ßo Unit√°rio:</strong> ${formatarMoeda(item.precoFinal, 'BRL')}</p>
                    <p><strong>Quantidade:</strong> ${quantidade} unidades</p>
                    <p><strong>Pre√ßo Total:</strong> ${formatarMoeda(item.precoFinal * quantidade, 'BRL')}</p>
                    <p><strong>Lucro Real:</strong> ${formatarMoeda(item.lucroReal || 0, 'BRL')} (${(item.percentualLucroReal || 0).toFixed(2)}%)</p>
                    ${item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : ''}
                    ${item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : ''}
                </div>
                <div class="item-actions">
                    <button class="edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Editar</button>
                    <button class="share-btn" data-id="${item.id}" style="background-color: #4895ef;"><i class="fas fa-share-alt"></i> Compartilhar</button>
                    <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Excluir</button>
                </div>
            `;
            itensSalvosDiv.appendChild(itemDiv);
        });
    }
    
    // Exibir itens em formato de tabela
    function exibirItensTabelaHTML(itensSalvos, itensSalvosDiv) {
        let html = `
            <table class="table-view">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Data</th>
                        <th>Custo</th>
                        <th>Pre√ßo Final</th>
                        <th>Lucro</th>
                        <th>Qtd</th>
                        <th>Pagamento</th>
                        <th>Cliente</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        itensSalvos.forEach(item => {
            const quantidade = item.quantidade || 1;
            const metodoPagamento = item.metodoPagamento === 'pix' ? 'Pix' : 'Cart√£o';
            
            html += `
                <tr>
                    <td>${item.nomeProduto}</td>
                    <td>${formatarData(item.dataCotacao)}</td>
                    <td>${formatarMoeda(item.custoReais, 'BRL')}</td>
                    <td>${formatarMoeda(item.precoFinal, 'BRL')}</td>
                    <td>${formatarMoeda(item.lucroReal || 0, 'BRL')} (${(item.percentualLucroReal || 0).toFixed(2)}%)</td>
                    <td>${quantidade}</td>
                    <td>${metodoPagamento}</td>
                    <td>${item.clienteNome || '-'}</td>
                    <td>
                        <button class="btn-small edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-small share-btn" data-id="${item.id}" style="background-color: #4895ef;"><i class="fas fa-share-alt"></i></button>
                        <button class="btn-small delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        itensSalvosDiv.innerHTML = html;
    }
    
    // Editar item
    function editarItem(id) {
        // Obter itens salvos
        const itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Encontrar item pelo id
        const item = itensSalvos.find(item => item.id == id);
        
        if (!item) {
            mostrarNotificacao('Item n√£o encontrado!', 'error');
            return;
        }
        
        // Mudar para a aba da calculadora
        document.querySelector('.tab-button[data-tab="calculator"]').click();
        
        // Preencher formul√°rio com dados do item
        document.getElementById('nomeProduto').value = item.nomeProduto;
        document.getElementById('dataCotacao').value = item.dataCotacao;
        document.getElementById('custoDolar').value = item.custoDolar;
        document.getElementById('cotacaoDolar').value = item.cotacaoDolar;
        document.getElementById('margemLucro').value = item.margemLucro;
        document.getElementById('quantidade').value = item.quantidade || 1;
        document.getElementById('observacoes').value = item.observacoes || '';
        
        if (item.metodoPagamento) {
            document.getElementById('metodoPagamento').value = item.metodoPagamento;
            toggleTaxaDisplay(); // Atualizar exibi√ß√£o de taxas
        }
        
        if (item.clienteId) {
            document.getElementById('clienteSelect').value = item.clienteId;
        }
        
        // Rolar para o formul√°rio
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        
        // Calcular pre√ßo para mostrar resultado
        calcularPreco();
        
        // Pegar o bot√£o de salvar que foi criado ao calcular o pre√ßo
        const salvarBtn = document.getElementById('salvarBtn');
        
        // Atualizar texto e evento do bot√£o
        salvarBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Edi√ß√£o';
        
        // Remover eventos anteriores (clonar e substituir o bot√£o)
        const novoSalvarBtn = salvarBtn.cloneNode(true);
        salvarBtn.parentNode.replaceChild(novoSalvarBtn, salvarBtn);
        
        // Adicionar novo evento
        novoSalvarBtn.addEventListener('click', function() {
            // Remover item antigo
            excluirItem(id, false);
            
            // Salvar como novo item
            salvarItem(window.calculoAtual);
            
            mostrarNotificacao('Or√ßamento atualizado com sucesso!');
        });
    }
    
    // Excluir item
    function excluirItem(id, confirmar = true) {
        if (confirmar && !confirm('Tem certeza que deseja excluir este or√ßamento?')) {
            return;
        }
        
        // Obter itens salvos
        let itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Obter item antes de excluir (para sincroniza√ß√£o com a nuvem)
        const item = itensSalvos.find(item => item.id == id);
        
        // Filtrar item a ser exclu√≠do
        itensSalvos = itensSalvos.filter(item => item.id != id);
        
        // Salvar no localStorage
        localStorage.setItem('calculadoraLucro', JSON.stringify(itensSalvos));
        
        // Atualizar dashboard
        atualizarDashboard();
        
        // Recarregar lista de itens
        carregarItensSalvos();
        
        if (confirmar) {
            mostrarNotificacao('Or√ßamento exclu√≠do com sucesso!');
        }
        
        // Se o usu√°rio estiver logado e o Firebase estiver configurado, excluir na nuvem
        if (usuarioAtual && firebase.apps.length > 0 && item && item.firebaseId) {
            excluirItemNaNuvem(item.firebaseId);
        }
    }
    
    // Excluir item na nuvem (Firebase)
    async function excluirItemNaNuvem(firebaseId) {
        try {
            // Refer√™ncia ao Firestore
            const db = firebase.firestore();
            
            // Excluir do Firestore
            await db.collection('orcamentos').doc(firebaseId).delete();
            
            console.log('Item exclu√≠do da nuvem com sucesso!');
        } catch (error) {
            console.error('Erro ao excluir item da nuvem:', error);
        }
    }
    
    // Filtrar or√ßamentos
    function filtrarOrcamentos() {
        carregarItensSalvos();
    }
    
    // Exportar para CSV
    function exportarCSV() {
        const itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        if (itensSalvos.length === 0) {
            mostrarNotificacao('N√£o h√° or√ßamentos para exportar.', 'error');
            return;
        }
        
        // Formatar dados para CSV
        let csv = 'Nome do Produto,Data da Cota√ß√£o,Custo em D√≥lar,Cota√ß√£o do D√≥lar,Custo em Reais,Margem de Lucro,Pre√ßo Final,Quantidade,M√©todo de Pagamento,Lucro Real,Percentual de Lucro,Cliente,Observa√ß√µes\n';
        
        itensSalvos.forEach(item => {
            const metodoPagamento = item.metodoPagamento === 'pix' ? 'Pix' : 'Cart√£o';
            const quantidade = item.quantidade || 1;
            
            csv += `"${item.nomeProduto.replace(/"/g, '""')}",`;
            csv += `"${formatarData(item.dataCotacao)}",`;
            csv += `"${item.custoDolar}",`;
            csv += `"${item.cotacaoDolar}",`;
            csv += `"${item.custoReais.toFixed(2)}",`;
            csv += `"${item.margemLucro}%",`;
            csv += `"${item.precoFinal.toFixed(2)}",`;
            csv += `"${quantidade}",`;
            csv += `"${metodoPagamento}",`;
            csv += `"${(item.lucroReal || 0).toFixed(2)}",`;
            csv += `"${(item.percentualLucroReal || 0).toFixed(2)}%",`;
            csv += `"${(item.clienteNome || '').replace(/"/g, '""')}",`;
            csv += `"${(item.observacoes || '').replace(/"/g, '""')}"\n`;
        });
        
        // Criar arquivo para download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'orcamentos_led_line_br_parts.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        mostrarNotificacao('Arquivo CSV exportado com sucesso!');
    }

    // Exportar para Excel
    function exportarExcel() {
        const itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        if (itensSalvos.length === 0) {
            mostrarNotificacao('N√£o h√° or√ßamentos para exportar.', 'error');
            return;
        }
        
        // Formatar dados para CSV (usado para Excel)
        let csv = 'Nome do Produto,Data da Cota√ß√£o,Custo em D√≥lar,Cota√ß√£o do D√≥lar,Custo em Reais,Margem de Lucro,Pre√ßo Final,Quantidade,M√©todo de Pagamento,Lucro Real,Percentual de Lucro,Cliente,Observa√ß√µes\n';
        
        itensSalvos.forEach(item => {
            const metodoPagamento = item.metodoPagamento === 'pix' ? 'Pix' : 'Cart√£o';
            const quantidade = item.quantidade || 1;
            
            csv += `"${item.nomeProduto.replace(/"/g, '""')}",`;
            csv += `"${formatarData(item.dataCotacao)}",`;
            csv += `"${item.custoDolar}",`;
            csv += `"${item.cotacaoDolar}",`;
            csv += `"${item.custoReais.toFixed(2)}",`;
            csv += `"${item.margemLucro}%",`;
            csv += `"${item.precoFinal.toFixed(2)}",`;
            csv += `"${quantidade}",`;
            csv += `"${metodoPagamento}",`;
            csv += `"${(item.lucroReal || 0).toFixed(2)}",`;
            csv += `"${(item.percentualLucroReal || 0).toFixed(2)}%",`;
            csv += `"${(item.clienteNome || '').replace(/"/g, '""')}",`;
            csv += `"${(item.observacoes || '').replace(/"/g, '""')}"\n`;
        });
        
        // Criar arquivo para download
        const blob = new Blob([csv], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'orcamentos_led_line_br_parts.xls');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        mostrarNotificacao('Arquivo Excel exportado com sucesso!');
    }
    
    // Limpar todos os dados
    function limparDados() {
        if (confirm('Tem certeza que deseja excluir TODOS os or√ßamentos salvos? Esta a√ß√£o n√£o pode ser desfeita.')) {
            localStorage.removeItem('calculadoraLucro');
            carregarItensSalvos();
            atualizarDashboard();
            mostrarNotificacao('Todos os or√ßamentos foram exclu√≠dos!');
        }
    }
    
    // Definir bot√£o de visualiza√ß√£o ativo
    function setActiveViewButton(buttonId) {
        document.getElementById('cardViewBtn').classList.remove('active');
        document.getElementById('tableViewBtn').classList.remove('active');
        document.getElementById(buttonId).classList.add('active');
    }
    
    // Abrir modal de compartilhamento
    function abrirModalCompartilhar(item) {
        const modal = document.getElementById('shareModal');
        const shareContent = document.getElementById('shareContent');
        
        const cliente = item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : '';
        const observacoes = item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : '';
        
        // Preencher conte√∫do do modal
        shareContent.innerHTML = `
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">${item.nomeProduto}</h4>
                <p><strong>Pre√ßo Unit√°rio:</strong> ${formatarMoeda(item.precoFinal, 'BRL')}</p>
                <p><strong>Quantidade:</strong> ${item.quantidade || 1} unidades</p>
                <p><strong>Pre√ßo Total:</strong> ${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}</p>
                ${cliente}
                ${observacoes}
            </div>
        `;
        
        // Armazenar o item atual para compartilhamento
        window.itemParaCompartilhar = item;
        
        // Exibir modal
        modal.style.display = 'block';
    }
    
    // Compartilhar via WhatsApp
    function compartilharWhatsApp() {
        const item = window.itemParaCompartilhar;
        
        if (!item) return;
        
        const texto = `*Or√ßamento: ${item.nomeProduto}*
    
Pre√ßo Unit√°rio: ${formatarMoeda(item.precoFinal, 'BRL')}
Quantidade: ${item.quantidade || 1} unidades
Pre√ßo Total: ${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}

${item.observacoes ? 'Observa√ß√µes: ' + item.observacoes : ''}

Or√ßamento gerado por LED LINE BR PARTS`;

        // Criar URL para WhatsApp
        const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
        
        // Abrir em nova aba
        window.open(url, '_blank');
        
        // Fechar modal
        document.getElementById('shareModal').style.display = 'none';
    }
    
    // Compartilhar via Email
    function compartilharEmail() {
        const item = window.itemParaCompartilhar;
        
        if (!item) return;
        
        const assunto = `Or√ßamento: ${item.nomeProduto}`;
        
        const corpo = `Or√ßamento: ${item.nomeProduto}
    
Pre√ßo Unit√°rio: ${formatarMoeda(item.precoFinal, 'BRL')}
Quantidade: ${item.quantidade || 1} unidades
Pre√ßo Total: ${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}

${item.observacoes ? 'Observa√ß√µes: ' + item.observacoes : ''}

Or√ßamento gerado por LED LINE BR PARTS`;

        // Criar URL para email
        const url = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
        
        // Abrir cliente de email
        window.location.href = url;
        
        // Fechar modal
        document.getElementById('shareModal').style.display = 'none';
    }
    
    // Compartilhar como PDF
    function compartilharPDF() {
        const item = window.itemParaCompartilhar;
        
        if (!item) return;
        
        // Preparar conte√∫do para PDF
        const content = document.createElement('div');
        content.innerHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="color: #0d838c; text-align: center;">LED LINE BR PARTS</h1>
                <h2 style="text-align: center;">Or√ßamento</h2>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #0d838c;">${item.nomeProduto}</h3>
                    <p><strong>Data:</strong> ${formatarData(item.dataCotacao)}</p>
                    ${item.clienteNome ? `<p><strong>Cliente:</strong> ${item.clienteNome}</p>` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Item</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Valor</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Custo em D√≥lar</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.custoDolar, 'USD')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Cota√ß√£o do D√≥lar</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.cotacaoDolar, 'BRL')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Pre√ßo Unit√°rio</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.precoFinal, 'BRL')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">Quantidade</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${item.quantidade || 1} unidades</td>
                        </tr>
                        <tr style="font-weight: bold; background-color: #f2f2f2;">
                            <td style="padding: 10px; border: 1px solid #ddd;">Pre√ßo Total</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formatarMoeda(item.precoFinal * (item.quantidade || 1), 'BRL')}</td>
                        </tr>
                    </table>
                    
                    ${item.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${item.observacoes}</p>` : ''}
                    
                    <div style="margin-top: 30px; font-size: 12px; color: #666; text-align: center;">
                        <p>Or√ßamento gerado em ${formatarData(new Date().toISOString())}</p>
                        <p>LED LINE BR PARTS</p>
                    </div>
                </div>
            </div>
        `;
        
        // Colocar elemento na p√°gina temporariamente
        document.body.appendChild(content);
        
        // Usar html2canvas e jsPDF para gerar PDF
        html2canvas(content).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`orcamento_${item.nomeProduto.replace(/\s+/g, '_')}.pdf`);
            
            // Remover elemento tempor√°rio
            document.body.removeChild(content);
            
            // Fechar modal
            document.getElementById('shareModal').style.display = 'none';
        });
    }
    
    // Compartilhar como link
    function compartilharLink() {
        const item = window.itemParaCompartilhar;
        
        if (!item) return;
        
        // Criar objeto com dados essenciais para compartilhamento
        const dadosCompartilhados = {
            nomeProduto: item.nomeProduto,
            precoFinal: item.precoFinal,
            quantidade: item.quantidade || 1,
            observacoes: item.observacoes || '',
            dataGeracao: new Date().toISOString()
        };
        
        // Converter para base64
        const dadosBase64 = btoa(JSON.stringify(dadosCompartilhados));
        
        // Criar URL com par√¢metro de dados
        const url = `${window.location.href.split('?')[0]}?share=${dadosBase64}`;
        
        // Copiar para √°rea de transfer√™ncia
        navigator.clipboard.writeText(url)
            .then(() => {
                mostrarNotificacao('Link copiado para a √°rea de transfer√™ncia!');
                
                // Fechar modal
                document.getElementById('shareModal').style.display = 'none';
            })
            .catch(err => {
                console.error('Erro ao copiar link:', err);
                mostrarNotificacao('Erro ao copiar link. Tente novamente.', 'error');
            });
    }
    
    // Carregar dados compartilhados via URL
    function carregarDadosCompartilhados() {
        const urlParams = new URLSearchParams(window.location.search);
        const dadosCompartilhados = urlParams.get('share');
        
        if (dadosCompartilhados) {
            try {
                // Decodificar dados
                const dados = JSON.parse(atob(dadosCompartilhados));
                
                // Exibir notifica√ß√£o
                mostrarNotificacao('Or√ßamento compartilhado carregado!');
                
                // Preencher formul√°rio com dados
                document.getElementById('nomeProduto').value = dados.nomeProduto;
                document.getElementById('quantidade').value = dados.quantidade;
                
                // Exibir modal ou alertar
                setTimeout(() => {
                    alert(`Or√ßamento compartilhado: ${dados.nomeProduto}\nPre√ßo: ${formatarMoeda(dados.precoFinal, 'BRL')}\nQuantidade: ${dados.quantidade} unidades\nTotal: ${formatarMoeda(dados.precoFinal * dados.quantidade, 'BRL')}\n\n${dados.observacoes ? 'Observa√ß√µes: ' + dados.observacoes : ''}`);
                }, 1000);
            } catch (error) {
                console.error('Erro ao carregar dados compartilhados:', error);
            }
        }
    }
    
    // Abrir modal de cliente
    function abrirModalCliente() {
        // Limpar formul√°rio
        document.getElementById('clientName').value = '';
        document.getElementById('clientEmail').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('clientNotes').value = '';
        
        // Exibir modal
        document.getElementById('clientModal').style.display = 'block';
    }
    
    // Salvar cliente
    function salvarCliente() {
        const nome = document.getElementById('clientName').value;
        const email = document.getElementById('clientEmail').value;
        const telefone = document.getElementById('clientPhone').value;
        const observacoes = document.getElementById('clientNotes').value;
        
        // Validar nome
        if (!nome) {
            mostrarNotificacao('Por favor, informe o nome do cliente.', 'error');
            return;
        }
        
        // Criar objeto do cliente
        const cliente = {
            id: Date.now(),
            nome,
            email,
            telefone,
            observacoes,
            dataCadastro: new Date().toISOString()
        };
        
        // Carregar clientes salvos
        let clientes = JSON.parse(localStorage.getItem('calculadoraClientes')) || [];
        
        // Adicionar novo cliente
        clientes.push(cliente);
        
        // Salvar no localStorage
        localStorage.setItem('calculadoraClientes', JSON.stringify(clientes));
        
        // Fechar modal
        document.getElementById('clientModal').style.display = 'none';
        
        // Recarregar lista de clientes
        carregarClientes();
        
        // Atualizar select de clientes
        atualizarSelectClientes();
        
        mostrarNotificacao('Cliente salvo com sucesso!');
    }
    
    // Carregar clientes
    function carregarClientes() {
        const clientes = JSON.parse(localStorage.getItem('calculadoraClientes')) || [];
        clientesData = clientes;
        
        // Exibir clientes na aba de clientes
        exibirListaClientes(clientes);
        
        // Atualizar select de clientes
        atualizarSelectClientes();
    }
    
    // Exibir lista de clientes
    function exibirListaClientes(clientes) {
        const clientList = document.getElementById('clientList');
        
        if (clientes.length === 0) {
            clientList.innerHTML = '<p>Nenhum cliente cadastrado ainda.</p>';
            return;
        }
        
        let html = '';
        
        clientes.forEach(cliente => {
            html += `
                <div class="client-item">
                    <div>
                        <h4 style="margin: 0; color: var(--primary);">${cliente.nome}</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                            ${cliente.email ? `<span><i class="fas fa-envelope"></i> ${cliente.email}</span>` : ''}
                            ${cliente.telefone ? `<span style="margin-left: 10px;"><i class="fas fa-phone"></i> ${cliente.telefone}</span>` : ''}
                        </p>
                    </div>
                    <div>
                        <button class="btn-small edit-client-btn" data-id="${cliente.id}" style="background-color: var(--warning);"><i class="fas fa-edit"></i></button>
                        <button class="btn-small delete-client-btn" data-id="${cliente.id}" style="background-color: var(--danger);"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
        
        clientList.innerHTML = html;
        
        // Adicionar eventos aos bot√µes
        document.querySelectorAll('.edit-client-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                editarCliente(this.getAttribute('data-id'));
            });
        });
        
        document.querySelectorAll('.delete-client-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                excluirCliente(this.getAttribute('data-id'));
            });
        });
    }
    
    // Filtrar clientes
    function filtrarClientes() {
        const filtro = document.getElementById('filtroClientes').value.trim().toLowerCase();
        let clientes = JSON.parse(localStorage.getItem('calculadoraClientes')) || [];
        
        if (filtro) {
            clientes = clientes.filter(cliente => 
                cliente.nome.toLowerCase().includes(filtro) || 
                (cliente.email && cliente.email.toLowerCase().includes(filtro)) ||
                (cliente.telefone && cliente.telefone.includes(filtro))
            );
        }
        
        exibirListaClientes(clientes);
    }
    
    // Atualizar select de clientes
    function atualizarSelectClientes() {
        const select = document.getElementById('clienteSelect');
        const clientes = JSON.parse(localStorage.getItem('calculadoraClientes')) || [];
        
        // Manter a op√ß√£o vazia
        let html = '<option value="">Selecione um cliente</option>';
        
        // Adicionar op√ß√µes de clientes
        clientes.forEach(cliente => {
            html += `<option value="${cliente.id}">${cliente.nome}</option>`;
        });
        
        select.innerHTML = html;
    }
    
    // Editar cliente
    function editarCliente(id) {
        const clientes = JSON.parse(localStorage.getItem('calculadoraClientes')) || [];
        const cliente = clientes.find(c => c.id == id);
        
        if (!cliente) {
            mostrarNotificacao('Cliente n√£o encontrado!', 'error');
            return;
        }
        
        // Preencher formul√°rio
        document.getElementById('clientName').value = cliente.nome;
        document.getElementById('clientEmail').value = cliente.email || '';
        document.getElementById('clientPhone').value = cliente.telefone || '';
        document.getElementById('clientNotes').value = cliente.observacoes || '';
        
        // Exibir modal
        document.getElementById('clientModal').style.display = 'block';
        
        // Alterar comportamento do bot√£o salvar
        const saveBtn = document.getElementById('saveClientBtn');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Cliente';
        
        // Remover eventos anteriores
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        
        // Adicionar novo evento
        newSaveBtn.addEventListener('click', function() {
            // Obter dados atualizados
            const nome = document.getElementById('clientName').value;
            const email = document.getElementById('clientEmail').value;
            const telefone = document.getElementById('clientPhone').value;
            const observacoes = document.getElementById('clientNotes').value;
            
            // Validar nome
            if (!nome) {
                mostrarNotificacao('Por favor, informe o nome do cliente.', 'error');
                return;
            }
            
            // Atualizar cliente
            const index = clientes.findIndex(c => c.id == id);
            
            if (index !== -1) {
                clientes[index] = {
                    ...clientes[index],
                    nome,
                    email,
                    telefone,
                    observacoes,
                    dataAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                localStorage.setItem('calculadoraClientes', JSON.stringify(clientes));
                
                // Fechar modal
                document.getElementById('clientModal').style.display = 'none';
                
                // Recarregar lista de clientes
                carregarClientes();
                
                mostrarNotificacao('Cliente atualizado com sucesso!');
            }
        });
    }
    
    // Excluir cliente
    function excluirCliente(id) {
        if (!confirm('Tem certeza que deseja excluir este cliente?')) {
            return;
        }
        
        let clientes = JSON.parse(localStorage.getItem('calculadoraClientes')) || [];
        
        // Filtrar cliente a ser exclu√≠do
        clientes = clientes.filter(c => c.id != id);
        
        // Salvar no localStorage
        localStorage.setItem('calculadoraClientes', JSON.stringify(clientes));
        
        // Recarregar lista de clientes
        carregarClientes();
        
        mostrarNotificacao('Cliente exclu√≠do com sucesso!');
    }
    
    // Atualizar dashboard
    function atualizarDashboard() {
        const itensSalvos = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
        
        // Contar total de or√ßamentos
        document.getElementById('totalOrcamentos').textContent = itensSalvos.length;
        
        // Calcular valor total
        const valorTotal = itensSalvos.reduce((total, item) => total + (item.precoFinal * (item.quantidade || 1)), 0);
        document.getElementById('valorTotal').textContent = formatarMoeda(valorTotal, 'BRL');
        
        // Gr√°fico de m√©todos de pagamento
        atualizarGraficoMetodosPagamento(itensSalvos);
        
        // Gr√°fico de or√ßamentos por m√™s
        atualizarGraficoOrcamentosPorMes(itensSalvos);
    }
    
    // Atualizar gr√°fico de m√©todos de pagamento
    function atualizarGraficoMetodosPagamento(itensSalvos) {
        const ctx = document.getElementById('paymentMethodChart').getContext('2d');
        
        // Contar m√©todos de pagamento
        const cartao = itensSalvos.filter(item => item.metodoPagamento === 'cartao').length;
        const pix = itensSalvos.filter(item => item.metodoPagamento === 'pix').length;
        
        // Determinar cor do texto com base no tema
        const tema = document.body.getAttribute('data-theme');
        const corTexto = tema === 'dark' ? '#f0f0f0' : '#212529';
        
        // Destruir gr√°fico anterior se existir
        if (paymentMethodChart) {
            paymentMethodChart.destroy();
        }
        
        // Criar novo gr√°fico
        paymentMethodChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Cart√£o de Cr√©dito', 'Pix'],
                datasets: [{
                    data: [cartao, pix],
                    backgroundColor: ['#4cc9f0', '#0d838c']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: corTexto
                        }
                    }
                }
            }
        });
    }
    
    // Atualizar gr√°fico de or√ßamentos por m√™s
    function atualizarGraficoOrcamentosPorMes(itensSalvos) {
        const ctx = document.getElementById('monthlyBudgetChart').getContext('2d');
        
        // Agrupar or√ßamentos por m√™s
        const orcamentosPorMes = {};
        
        itensSalvos.forEach(item => {
            // Usar data de cria√ß√£o ou cota√ß√£o
            const data = new Date(item.dataCriacao || item.dataCotacao);
            const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
            
            if (!orcamentosPorMes[mesAno]) {
                orcamentosPorMes[mesAno] = 0;
            }
            
            orcamentosPorMes[mesAno]++;
        });
        
        // Preparar dados para o gr√°fico
        const meses = Object.keys(orcamentosPorMes).sort((a, b) => {
            const [mesA, anoA] = a.split('/').map(Number);
            const [mesB, anoB] = b.split('/').map(Number);
            
            if (anoA !== anoB) {
                return anoA - anoB;
            }
            
            return mesA - mesB;
        });
        
        const quantidades = meses.map(mes => orcamentosPorMes[mes]);
        
        // Determinar cor do texto com base no tema
        const tema = document.body.getAttribute('data-theme');
        const corTexto = tema === 'dark' ? '#f0f0f0' : '#212529';
        
        // Destruir gr√°fico anterior se existir
        if (monthlyBudgetChart) {
            monthlyBudgetChart.destroy();
        }
        
        // Criar novo gr√°fico
        monthlyBudgetChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [{
                    label: 'Or√ßamentos',
                    data: quantidades,
                    backgroundColor: '#0d838c'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            color: corTexto
                        }
                    },
                    x: {
                        ticks: {
                            color: corTexto
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: corTexto
                        }
                    }
                }
            }
        });
    }
    
    // Abrir modal de login
    function abrirModalLogin() {
        document.getElementById('loginModal').style.display = 'block';
    }
    
    // Fazer login
    async function fazerLogin() {
        // Se o Firebase n√£o estiver configurado, mostrar mensagem
        if (firebase.apps.length === 0) {
            mostrarNotificacao('Funcionalidade em manuten√ß√£o. Tente novamente mais tarde.', 'error');
            return;
        }
        
        const email = document.getElementById('loginEmail').value;
        const senha = document.getElementById('loginPassword').value;
        
        // Validar campos
        if (!email || !senha) {
            mostrarNotificacao('Por favor, preencha todos os campos.', 'error');
            return;
        }
        
        try {
            // Configurar persist√™ncia (sess√£o atual ou entre sess√µes)
            await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            
            // Fazer login no Firebase
            const resultado = await firebase.auth().signInWithEmailAndPassword(email, senha);
            
            // Armazenar usu√°rio
            usuarioAtual = resultado.user;
            
            // Fechar modal
            document.getElementById('loginModal').style.display = 'none';
            
            // Atualizar status de login
            atualizarStatusLogin();
            
            // Sincronizar dados
            sincronizarDados();
            
            mostrarNotificacao('Login realizado com sucesso!');
        } catch (error) {
            console.error('Erro ao fazer login:', error);
            
            // Mensagens de erro mais amig√°veis
            let mensagemErro = 'Erro ao fazer login. Verifique suas credenciais.';
            
            if (error.code === 'auth/user-not-found') {
                mensagemErro = 'Usu√°rio n√£o encontrado. Verifique seu e-mail ou crie uma conta.';
            } else if (error.code === 'auth/wrong-password') {
                mensagemErro = 'Senha incorreta. Tente novamente.';
            } else if (error.code === 'auth/invalid-email') {
                mensagemErro = 'E-mail inv√°lido. Verifique o formato.';
            } else if (error.code === 'auth/too-many-requests') {
                mensagemErro = 'Muitas tentativas. Tente novamente mais tarde.';
            }
            
            mostrarNotificacao(mensagemErro, 'error');
        }
    }
    
    // Registrar usu√°rio
    async function registrarUsuario() {
        // Se o Firebase n√£o estiver configurado, mostrar mensagem
        if (firebase.apps.length === 0) {
            mostrarNotificacao('Funcionalidade em manuten√ß√£o. Tente novamente mais tarde.', 'error');
            return;
        }
        
        const email = document.getElementById('loginEmail').value;
        const senha = document.getElementById('loginPassword').value;
        
        // Validar campos
        if (!email || !senha) {
            mostrarNotificacao('Por favor, preencha todos os campos.', 'error');
            return;
        }
        
        // Validar for√ßa da senha
        if (senha.length < 6) {
            mostrarNotificacao('A senha deve ter pelo menos 6 caracteres.', 'error');
            return;
        }
        
        try {
            // Criar usu√°rio no Firebase
            const resultado = await firebase.auth().createUserWithEmailAndPassword(email, senha);
            
            // Armazenar usu√°rio
            usuarioAtual = resultado.user;
            
            // Fechar modal
            document.getElementById('loginModal').style.display = 'none';
            
            // Atualizar status de login
            atualizarStatusLogin();
            
            mostrarNotificacao('Conta criada com sucesso!');
        } catch (error) {
            console.error('Erro ao criar conta:', error);
            
            // Mensagens de erro mais amig√°veis
            let mensagemErro = 'Erro ao criar conta. Tente novamente.';
            
            if (error.code === 'auth/email-already-in-use') {
                mensagemErro = 'E-mail j√° cadastrado. Tente fazer login.';
            } else if (error.code === 'auth/invalid-email') {
                mensagemErro = 'E-mail inv√°lido. Verifique o formato.';
            } else if (error.code === 'auth/weak-password') {
                mensagemErro = 'Senha fraca. Use uma senha mais forte.';
            }
            
            mostrarNotificacao(mensagemErro, 'error');
        }
    }
    
    // Atualizar status de login
    function atualizarStatusLogin() {
        const loginBtn = document.getElementById('loginStatusBtn');
        const userInfo = document.getElementById('userInfo');
        
        if (usuarioAtual) {
            loginBtn.style.display = 'none';
            userInfo.style.display = 'block';
            userInfo.innerHTML = `<span style="margin-right: 10px;">${usuarioAtual.email}</span><button id="logoutBtn" class="btn-small" style="background-color: #6c757d;"><i class="fas fa-sign-out-alt"></i></button>`;
            
            // Adicionar evento ao bot√£o de logout
            document.getElementById('logoutBtn').addEventListener('click', fazerLogout);
        } else {
            loginBtn.style.display = 'block';
            userInfo.style.display = 'none';
        }
    }
    
    // Fazer logout
    async function fazerLogout() {
        // Se o Firebase n√£o estiver configurado, resetar vari√°vel
        if (firebase.apps.length === 0) {
            usuarioAtual = null;
            atualizarStatusLogin();
            return;
        }
        
        try {
            // Fazer logout no Firebase
            await firebase.auth().signOut();
            
            // Resetar vari√°vel
            usuarioAtual = null;
            
            // Atualizar status de login
            atualizarStatusLogin();
            
            mostrarNotificacao('Logout realizado com sucesso!');
        } catch (error) {
            console.error('Erro ao fazer logout:', error);
        }
    }
    
    // Sincronizar dados com a nuvem
    async function sincronizarDados() {
        if (!usuarioAtual || firebase.apps.length === 0) {
            return;
        }
        
        try {
            // Refer√™ncia ao Firestore
            const db = firebase.firestore();
            
            // Obter or√ßamentos do usu√°rio
            const snapshot = await db.collection('orcamentos')
                .where('userId', '==', usuarioAtual.uid)
                .get();
            
            // Obter or√ßamentos locais
            let orcamentosLocais = JSON.parse(localStorage.getItem('calculadoraLucro')) || [];
            
            // Mapear IDs dos or√ßamentos na nuvem
            const idsNaNuvem = new Set();
            const orcamentosNaNuvem = [];
            
            snapshot.forEach(doc => {
                const orcamento = doc.data();
                orcamento.firebaseId = doc.id;
                idsNaNuvem.add(orcamento.id);
                orcamentosNaNuvem.push(orcamento);
            });
            
            // Identificar or√ßamentos que est√£o apenas localmente
            const orcamentosApenaLocais = orcamentosLocais.filter(o => !idsNaNuvem.has(o.id));
            
            // Salvar or√ßamentos locais na nuvem
            for (const orcamento of orcamentosApenaLocais) {
                orcamento.userId = usuarioAtual.uid;
                const docRef = await db.collection('orcamentos').add(orcamento);
                orcamento.firebaseId = docRef.id;
            }
            
            // Identificar IDs dos or√ßamentos locais
            const idsLocais = new Set(orcamentosLocais.map(o => o.id));
            
            // Identificar or√ßamentos que est√£o apenas na nuvem
            const orcamentosApenaNaNuvem = orcamentosNaNuvem.filter(o => !idsLocais.has(o.id));
            
            // Adicionar or√ßamentos da nuvem localmente
            if (orcamentosApenaNaNuvem.length > 0) {
                orcamentosLocais = [...orcamentosLocais, ...orcamentosApenaNaNuvem];
                localStorage.setItem('calculadoraLucro', JSON.stringify(orcamentosLocais));
                
                // Recarregar lista
                carregarItensSalvos();
                
                // Notificar usu√°rio
                mostrarNotificacao(`Sincronizado ${orcamentosApenaNaNuvem.length} or√ßamentos da nuvem.`);
            }
            
        } catch (error) {
            console.error('Erro ao sincronizar dados:', error);
            mostrarNotificacao('Erro ao sincronizar dados com a nuvem.', 'error');
        }
    }
    
    // Formatar moeda
    function formatarMoeda(valor, moeda = 'BRL') {
        if (isNaN(valor)) return '0,00';
        
        return new Intl.NumberFormat('pt-BR', { 
            style: 'currency', 
            currency: moeda 
        }).format(valor);
    }
    
    // Mostrar notifica√ß√£o
    function mostrarNotificacao(mensagem, tipo = 'success') {
        const notificacao = document.getElementById('notification');
        notificacao.textContent = mensagem;
        notificacao.style.backgroundColor = tipo === 'error' ? '#e63946' : tipo === 'warning' ? '#fd7e14' : '#0d838c';
        notificacao.classList.add('show');
        
        setTimeout(() => {
            notificacao.classList.remove('show');
        }, 3000);
    }
    
    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    console.log('Service Worker registrado com sucesso:', registration.scope);
                })
                .catch(function(error) {
                    console.log('Falha ao registrar Service Worker:', error);
                });
        });
    }
    
    // Verificar se h√° dados compartilhados na URL ao carregar
    document.addEventListener('DOMContentLoaded', carregarDadosCompartilhados);
        // Adicionar este c√≥digo √† se√ß√£o de scripts existente

// Fun√ß√£o para calcular o lucro a partir do valor de venda desejado
function calcularLucroDoValor() {
    // Obter valores dos campos
    const valorVendaDesejado = parseFloat(document.getElementById('valorVendaDesejado').value);
    const custoDolar = parseFloat(document.getElementById('custoDolar').value);
    const cotacaoDolar = parseFloat(document.getElementById('cotacaoDolar').value);
    const metodoPagamento = document.getElementById('metodoPagamento').value;
    
    // Validar inputs
    if (isNaN(valorVendaDesejado) || valorVendaDesejado <= 0 || isNaN(custoDolar) || custoDolar <= 0 || isNaN(cotacaoDolar) || cotacaoDolar <= 0) {
        mostrarNotificacao('Por favor, preencha o valor de venda, custo em d√≥lar e cota√ß√£o do d√≥lar.', 'error');
        return;
    }
    
    // Obter taxas personalizadas
    const config = JSON.parse(localStorage.getItem('calculadoraConfig')) || {
        taxas: {
            parcelamento: 14.35,
            pix: 0.79,
            yampi: 2.5,
            imposto: 10
        }
    };
    
    // Selecionar a taxa de pagamento correta com base no m√©todo e definir se h√° desconto de pix
    let taxaPagamento, descontoPix = false;
    let precoBase = valorVendaDesejado;
    
    // Para PIX, precisamos recalcular considerando que o valor informado j√° tem 5% de desconto
    if (metodoPagamento === 'pix') {
        // Se o m√©todo √© PIX, o valor inserido j√° tem o desconto de 5%
        // Precisamos "desfazer" o desconto para achar o valor base que seria cobrado no cart√£o
        precoBase = valorVendaDesejado / 0.95; // Desfaz o desconto de 5%
        taxaPagamento = config.taxas.parcelamento / 100;
        descontoPix = true;
    } else {
        taxaPagamento = config.taxas.parcelamento / 100;
    }
    
    const taxaYampi = config.taxas.yampi / 100;
    const taxaImposto = config.taxas.imposto / 100;
    
    // Calcular custos e lucro
    const custoReais = custoDolar * cotacaoDolar;
    
    // Calcular o total de taxas
    const totalTaxas = taxaPagamento + taxaYampi + taxaImposto;
    
    // Calcular o custo com as taxas
    const custoComTaxas = custoReais / (1 - totalTaxas);
    
    // Calcular lucro e margem
    let lucroReais, margemLucro, precoComTaxas;
    
    if (descontoPix) {
        // Para PIX: o lucro √© calculado considerando o pre√ßo base (sem desconto de 5%)
        precoComTaxas = precoBase; // pre√ßo base j√° foi calculado acima desfazendo o desconto
        lucroReais = precoBase - custoComTaxas;
        
        // O valor real de venda com PIX (ap√≥s desconto) √© o que foi informado
        const precoFinalPix = valorVendaDesejado;
        margemLucro = ((precoFinalPix - custoReais) / custoReais) * 100;
    } else {
        // Para cart√£o: o lucro √© direto
        lucroReais = valorVendaDesejado - custoComTaxas;
        margemLucro = ((valorVendaDesejado - custoReais) / custoReais) * 100;
        precoComTaxas = valorVendaDesejado;
    }
    
    const percentualLucroReal = (lucroReais / custoComTaxas) * 100;
    
    // Mostrar resultados
    const resultadoLucro = document.getElementById('resultadoLucro');
    const detalhesLucro = document.getElementById('detalhesLucro');
    
    detalhesLucro.innerHTML = `
        <p><strong>Custo em Reais:</strong> ${formatarMoeda(custoReais, 'BRL')}</p>
        <p><strong>Custo com Taxas:</strong> ${formatarMoeda(custoComTaxas, 'BRL')}</p>
        ${descontoPix ? 
            `<p><strong>Pre√ßo Base (equivalente cart√£o):</strong> ${formatarMoeda(precoBase, 'BRL')}</p>
            <p><strong>Pre√ßo com Desconto PIX (5%):</strong> ${formatarMoeda(valorVendaDesejado, 'BRL')}</p>` : 
            `<p><strong>Pre√ßo de Venda:</strong> ${formatarMoeda(valorVendaDesejado, 'BRL')}</p>`
        }
        <p><strong>Lucro em Reais:</strong> ${formatarMoeda(lucroReais, 'BRL')}</p>
        <p><strong>Margem sobre o Custo:</strong> ${margemLucro.toFixed(2)}%</p>
        <p><strong>Percentual de Lucro Real:</strong> ${percentualLucroReal.toFixed(2)}%</p>
    `;
    
    resultadoLucro.style.display = 'block';
    
    // Preencher campo de margem no formul√°rio principal se desejar
    document.getElementById('margemLucro').value = margemLucro.toFixed(2);
}
    </script>
</body>
</html>
