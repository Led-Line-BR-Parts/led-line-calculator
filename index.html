<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED LINE BR PARTS - CALCULADORA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LED LINE Calculadora">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#0d838c">
    <link rel="manifest" href="manifest.json">
    
    <!-- Fonts e CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    
    <!-- PDF.js para exportação PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #0d838c;
            --primary-dark: #0a6a71;
            --primary-light: #0fa3af;
            --secondary: #4cc9f0;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --gray-dark: #343a40;
            --white: #ffffff;
            --black: #000000;
            
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --background: #f5f7fa;
            --text: #2d3748;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --hover-bg: #f7fafc;
        }
        
        [data-theme="dark"] {
            --background: #0f172a;
            --text: #e2e8f0;
            --card-bg: #1e293b;
            --input-bg: #334155;
            --hover-bg: #334155;
            --light: #1e293b;
            --gray-light: #475569;
            --dark: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }
        
        /* Modern Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header h1 i {
            font-size: 1.5rem;
            opacity: 0.9;
        }
        
        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Modern Card */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card:hover {
            box-shadow: var(--box-shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Modern Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--card-bg);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--gray);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tab-button:hover {
            background: var(--hover-bg);
            color: var(--primary);
        }
        
        .tab-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(13, 131, 140, 0.3);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modern Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.95rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius-sm);
            font-family: inherit;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text);
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 131, 140, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        /* Modern Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(13, 131, 140, 0.4);
        }
        
        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: var(--gray);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Custos Fixos Section */
        .custos-fixos-container {
            background: linear-gradient(135deg, rgba(13, 131, 140, 0.05) 0%, rgba(76, 201, 240, 0.05) 100%);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .custos-fixos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .custos-fixos-list {
            display: grid;
            gap: 0.5rem;
        }
        
        .custo-fixo-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--gray-light);
        }
        
        .custo-fixo-nome {
            font-weight: 500;
        }
        
        .custo-fixo-valor {
            color: var(--primary);
            font-weight: 600;
        }
        
        .custo-fixo-tipo {
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            background: var(--gray-light);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .close-modal {
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        
        .close-modal:hover {
            opacity: 1;
        }
        
        /* Theme Switch */
        .theme-switch {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            background: var(--card-bg);
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .theme-switch input {
            display: none;
        }
        
        .theme-switch label {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .theme-switch label:hover {
            background: var(--hover-bg);
        }
        
        /* Results Section */
        .result {
            display: none;
            background: linear-gradient(135deg, rgba(13, 131, 140, 0.05) 0%, rgba(76, 201, 240, 0.05) 100%);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .result-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            margin: -1.5rem -1.5rem 1.5rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .result-item {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--primary);
        }
        
        .result-item-label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }
        
        .result-item-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--box-shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 1001;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        /* Table View */
        .table-responsive {
            overflow-x: auto;
            margin: -1rem;
            padding: 1rem;
        }
        
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .table tbody tr {
            transition: var(--transition);
        }
        
        .table tbody tr:hover {
            background: var(--hover-bg);
        }
        
        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dashboard-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-lg);
        }
        
        .dashboard-card-title {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dashboard-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .dashboard-card-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .dashboard-card-change.positive {
            color: var(--success);
        }
        
        .dashboard-card-change.negative {
            color: var(--danger);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .theme-switch {
                top: auto;
                bottom: 1rem;
            }
            
            .notification {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .custo-fixo-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--dark);
            color: white;
            text-align: center;
            border-radius: var(--border-radius-sm);
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-primary {
            background: rgba(13, 131, 140, 0.1);
            color: var(--primary);
        }
        
        .badge-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- Theme Switch -->
    <div class="theme-switch">
        <label for="theme-toggle">
            <i class="fas fa-sun" id="theme-icon"></i>
        </label>
        <input type="checkbox" id="theme-toggle">
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-calculator"></i> LED LINE BR PARTS</h1>
            <p>Sistema Avançado de Cálculo de Preços</p>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" data-tab="calculator">
                <i class="fas fa-calculator"></i> Calculadora
            </button>
            <button class="tab-button" data-tab="fixed-costs">
                <i class="fas fa-file-invoice-dollar"></i> Custos Fixos
            </button>
            <button class="tab-button" data-tab="history">
                <i class="fas fa-history"></i> Histórico
            </button>
            <button class="tab-button" data-tab="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-cog"></i> Configurações e Cálculo
                    </h2>
                </div>

                <!-- Custos Fixos Resumo -->
                <div class="custos-fixos-container" id="custos-fixos-resumo">
                    <div class="custos-fixos-header">
                        <h3 style="margin: 0; color: var(--primary);">
                            <i class="fas fa-info-circle"></i> Custos Fixos Mensais
                        </h3>
                        <span class="badge badge-primary" id="total-custos-fixos">R$ 0,00</span>
                    </div>
                    <p style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--gray);">
                        Seus custos fixos mensais serão distribuídos proporcionalmente com base no volume de vendas esperado.
                    </p>
                    <div style="margin-top: 1rem;">
                        <label for="vendas-esperadas" style="display: block; margin-bottom: 0.5rem;">
                            <i class="fas fa-chart-bar"></i> Vendas Esperadas no Mês:
                        </label>
                        <input type="number" id="vendas-esperadas" value="100" min="1" style="width: 150px;">
                        <button class="btn btn-sm btn-primary" onclick="abrirModalCustosFixos()" style="margin-left: 1rem;">
                            <i class="fas fa-edit"></i> Gerenciar Custos
                        </button>
                    </div>
                </div>

                <!-- Form -->
                <form id="calculator-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomeProduto">
                                <i class="fas fa-box"></i> Nome do Produto
                                <span class="tooltip">
                                    <i class="fas fa-question-circle" style="color: var(--gray); font-size: 0.875rem;"></i>
                                    <span class="tooltip-text">Nome ou descrição do produto</span>
                                </span>
                            </label>
                            <input type="text" id="nomeProduto" placeholder="Ex: Camiseta LED LINE" required>
                        </div>

                        <div class="form-group">
                            <label for="dataCotacao">
                                <i class="fas fa-calendar"></i> Data da Cotação
                            </label>
                            <input type="date" id="dataCotacao" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="custoDolar">
                                <i class="fas fa-dollar-sign"></i> Custo em Dólar (USD)
                            </label>
                            <input type="number" id="custoDolar" step="0.01" min="0" placeholder="10.00" required>
                        </div>

                        <div class="form-group">
                            <label for="cotacaoDolar">
                                <i class="fas fa-exchange-alt"></i> Cotação do Dólar (R$)
                            </label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" id="cotacaoDolar" step="0.01" min="0" placeholder="5.00" required>
                                <button type="button" class="btn btn-primary" onclick="atualizarCotacao()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="margemLucro">
                                <i class="fas fa-percent"></i> Margem de Lucro (%)
                            </label>
                            <input type="number" id="margemLucro" step="0.1" min="0" placeholder="40" required>
                        </div>

                        <div class="form-group">
                            <label for="quantidade">
                                <i class="fas fa-cubes"></i> Quantidade
                            </label>
                            <input type="number" id="quantidade" min="1" value="1" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="metodoPagamento">
                                <i class="fas fa-credit-card"></i> Método de Pagamento
                            </label>
                            <select id="metodoPagamento" required>
                                <option value="cartao">Cartão de Crédito (14.35%)</option>
                                <option value="pix">Pix (0.79%)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="taxaYampi">
                                <i class="fas fa-shopping-cart"></i> Taxa Yampi (%)
                            </label>
                            <input type="number" id="taxaYampi" step="0.01" min="0" value="2.5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="taxaImposto">
                            <i class="fas fa-receipt"></i> Imposto (%)
                        </label>
                        <input type="number" id="taxaImposto" step="0.01" min="0" value="10">
                    </div>

                    <div class="form-group">
                        <label for="observacoes">
                            <i class="fas fa-sticky-note"></i> Observações
                        </label>
                        <textarea id="observacoes" rows="3" placeholder="Informações adicionais..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-calculator"></i> Calcular Preço
                    </button>
                </form>

                <!-- Results -->
                <div class="result" id="resultado">
                    <div class="result-header">
                        <h3 style="margin: 0;"><i class="fas fa-chart-pie"></i> Resultado do Cálculo</h3>
                    </div>
                    
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-item-label">Custo em Reais</div>
                            <div class="result-item-value" id="res-custo-reais">R$ 0,00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">Custos Fixos</div>
                            <div class="result-item-value" id="res-custos-fixos">R$ 0,00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">Todas as Taxas</div>
                            <div class="result-item-value" id="res-taxas">R$ 0,00</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">Lucro Real</div>
                            <div class="result-item-value" id="res-lucro">R$ 0,00</div>
                        </div>
                    </div>

                    <div style="text-align: center; padding: 1.5rem; background: var(--card-bg); border-radius: var(--border-radius-sm); margin-top: 1rem;">
                        <div style="font-size: 0.875rem; color: var(--gray); margin-bottom: 0.5rem;">Preço Final Unitário</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary);" id="res-preco-final">R$ 0,00</div>
                        <div style="font-size: 1rem; color: var(--gray); margin-top: 0.5rem;">
                            Total para <span id="res-quantidade">1</span> unidade(s): 
                            <strong id="res-preco-total" style="color: var(--primary);">R$ 0,00</strong>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <canvas id="graficoDistribuicao" style="max-height: 300px;"></canvas>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="btn btn-success" onclick="salvarOrcamento()">
                            <i class="fas fa-save"></i> Salvar Orçamento
                        </button>
                        <button class="btn btn-primary" onclick="compartilharOrcamento()">
                            <i class="fas fa-share-alt"></i> Compartilhar
                        </button>
                        <button class="btn btn-secondary" onclick="exportarPDF()">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Items -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-archive"></i> Orçamentos Salvos
                    </h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-secondary" onclick="exportarCSV()">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="limparTodos()">
                            <i class="fas fa-trash"></i> Limpar
                        </button>
                    </div>
                </div>
                <div id="orcamentos-salvos"></div>
            </div>
        </div>

        <!-- Fixed Costs Tab -->
        <div id="fixed-costs" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-file-invoice-dollar"></i> Gerenciamento de Custos Fixos
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="abrirModalAdicionarCusto()">
                        <i class="fas fa-plus"></i> Adicionar Custo
                    </button>
                </div>
                
                <div id="lista-custos-fixos"></div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-line"></i> Histórico de Cotações
                    </h2>
                </div>
                <canvas id="cotacaoChart" style="max-height: 400px;"></canvas>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-title">Total de Orçamentos</div>
                    <div class="dashboard-card-value" id="dash-total-orcamentos">0</div>
                    <div class="dashboard-card-change positive">
                        <i class="fas fa-arrow-up"></i> +12% este mês
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-title">Valor Total</div>
                    <div class="dashboard-card-value" id="dash-valor-total">R$ 0,00</div>
                    <div class="dashboard-card-change positive">
                        <i class="fas fa-arrow-up"></i> +8% este mês
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-title">Ticket Médio</div>
                    <div class="dashboard-card-value" id="dash-ticket-medio">R$ 0,00</div>
                    <div class="dashboard-card-change negative">
                        <i class="fas fa-arrow-down"></i> -3% este mês
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-title">Margem Média</div>
                    <div class="dashboard-card-value" id="dash-margem-media">0%</div>
                    <div class="dashboard-card-change positive">
                        <i class="fas fa-arrow-up"></i> +2% este mês
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar"></i> Análise de Vendas
                    </h2>
                </div>
                <canvas id="vendas-chart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal Custos Fixos -->
    <div id="modal-custos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Adicionar Custo Fixo</h3>
                <span class="close-modal" onclick="fecharModal('modal-custos')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="custo-nome">
                        <i class="fas fa-tag"></i> Nome do Custo
                    </label>
                    <input type="text" id="custo-nome" placeholder="Ex: Shopify">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="custo-valor">
                            <i class="fas fa-money-bill"></i> Valor
                        </label>
                        <input type="number" id="custo-valor" step="0.01" placeholder="29.00">
                    </div>
                    <div class="form-group">
                        <label for="custo-moeda">
                            <i class="fas fa-coins"></i> Moeda
                        </label>
                        <select id="custo-moeda">
                            <option value="BRL">R$ (Real)</option>
                            <option value="USD">$ (Dólar)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="custo-tipo">
                        <i class="fas fa-list"></i> Tipo
                    </label>
                    <select id="custo-tipo">
                        <option value="fixo">Valor Fixo</option>
                        <option value="percentual">Percentual (%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="custo-descricao">
                        <i class="fas fa-comment"></i> Descrição
                    </label>
                    <textarea id="custo-descricao" rows="2" placeholder="Descrição opcional..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modal-custos')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCustoFixo()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Mensagem</span>
    </div>

    <script>
        // Estado Global
        let custosFixos = [];
        let orcamentosSalvos = [];
        let cotacaoHistorico = [];
        let chartDistribuicao = null;
        let chartCotacao = null;
        let chartVendas = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            inicializar();
        });

        function inicializar() {
            // Carregar dados salvos
            carregarDados();
            
            // Configurar data atual
            document.getElementById('dataCotacao').valueAsDate = new Date();
            
            // Configurar eventos
            configurarEventos();
            
            // Atualizar cotação do dólar
            atualizarCotacao();
            
            // Atualizar interface
            atualizarListaCustosFixos();
            atualizarOrcamentosSalvos();
            atualizarDashboard();
            atualizarResumoCustosFixos();
            
            // Verificar tema
            verificarTema();
        }

        function configurarEventos() {
            // Form submit
            document.getElementById('calculator-form').addEventListener('submit', function(e) {
                e.preventDefault();
                calcularPreco();
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('change', toggleTheme);
            
            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // Vendas esperadas
            document.getElementById('vendas-esperadas').addEventListener('change', function() {
                if (document.getElementById('resultado').style.display !== 'none') {
                    calcularPreco();
                }
            });
        }

        function switchTab(tabId) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // Refresh charts if needed
            if (tabId === 'history') {
                atualizarGraficoCotacao();
            } else if (tabId === 'dashboard') {
                atualizarDashboard();
            }
        }

        function toggleTheme() {
            const isChecked = document.getElementById('theme-toggle').checked;
            const theme = isChecked ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').className = isChecked ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('theme', theme);
            
            // Update charts
            if (chartDistribuicao) {
                atualizarTemaGrafico(chartDistribuicao);
            }
            if (chartCotacao) {
                atualizarTemaGrafico(chartCotacao);
            }
            if (chartVendas) {
                atualizarTemaGrafico(chartVendas);
            }
        }

        function verificarTema() {
            const theme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-toggle').checked = theme === 'dark';
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function atualizarTemaGrafico(chart) {
            const theme = document.body.getAttribute('data-theme');
            const textColor = theme === 'dark' ? '#e2e8f0' : '#2d3748';
            
            chart.options.plugins.legend.labels.color = textColor;
            if (chart.options.scales) {
                if (chart.options.scales.x) {
                    chart.options.scales.x.ticks.color = textColor;
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = textColor;
                }
            }
            chart.update();
        }

        // Custos Fixos Functions
        function abrirModalCustosFixos() {
            switchTab('fixed-costs');
        }

        function abrirModalAdicionarCusto() {
            document.getElementById('modal-custos').style.display = 'block';
            // Limpar campos
            document.getElementById('custo-nome').value = '';
            document.getElementById('custo-valor').value = '';
            document.getElementById('custo-moeda').value = 'BRL';
            document.getElementById('custo-tipo').value = 'fixo';
            document.getElementById('custo-descricao').value = '';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function salvarCustoFixo() {
            const nome = document.getElementById('custo-nome').value;
            const valor = parseFloat(document.getElementById('custo-valor').value);
            const moeda = document.getElementById('custo-moeda').value;
            const tipo = document.getElementById('custo-tipo').value;
            const descricao = document.getElementById('custo-descricao').value;
            
            if (!nome || !valor) {
                mostrarNotificacao('Por favor, preencha todos os campos obrigatórios', 'error');
                return;
            }
            
            const custo = {
                id: Date.now(),
                nome,
                valor,
                moeda,
                tipo,
                descricao,
                ativo: true
            };
            
            custosFixos.push(custo);
            salvarDados();
            atualizarListaCustosFixos();
            atualizarResumoCustosFixos();
            fecharModal('modal-custos');
            mostrarNotificacao('Custo fixo adicionado com sucesso!', 'success');
        }

        function removerCustoFixo(id) {
            if (confirm('Tem certeza que deseja remover este custo fixo?')) {
                custosFixos = custosFixos.filter(c => c.id !== id);
                salvarDados();
                atualizarListaCustosFixos();
                atualizarResumoCustosFixos();
                mostrarNotificacao('Custo fixo removido!', 'success');
            }
        }

        function toggleCustoFixo(id) {
            const custo = custosFixos.find(c => c.id === id);
            if (custo) {
                custo.ativo = !custo.ativo;
                salvarDados();
                atualizarListaCustosFixos();
                atualizarResumoCustosFixos();
            }
        }

        function atualizarListaCustosFixos() {
            const container = document.getElementById('lista-custos-fixos');
            
            if (custosFixos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray);">Nenhum custo fixo cadastrado.</p>';
                return;
            }
            
            let html = '<div class="custos-fixos-list">';
            
            custosFixos.forEach(custo => {
                const valorFormatado = custo.tipo === 'percentual' 
                    ? `${custo.valor}%` 
                    : formatarMoeda(custo.valor, custo.moeda);
                
                html += `
                    <div class="custo-fixo-item ${!custo.ativo ? 'opacity-50' : ''}">
                        <div>
                            <div class="custo-fixo-nome">${custo.nome}</div>
                            ${custo.descricao ? `<div style="font-size: 0.875rem; color: var(--gray);">${custo.descricao}</div>` : ''}
                        </div>
                        <div class="custo-fixo-valor">${valorFormatado}</div>
                        <div>
                            <span class="custo-fixo-tipo">${custo.tipo}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm ${custo.ativo ? 'btn-success' : 'btn-secondary'}" 
                                    onclick="toggleCustoFixo(${custo.id})" title="${custo.ativo ? 'Desativar' : 'Ativar'}">
                                <i class="fas fa-${custo.ativo ? 'check' : 'times'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removerCustoFixo(${custo.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function atualizarResumoCustosFixos() {
            const cotacaoDolar = parseFloat(document.getElementById('cotacaoDolar').value) || 5.0;
            let totalCustos = 0;
            
            custosFixos.filter(c => c.ativo).forEach(custo => {
                if (custo.tipo === 'fixo') {
                    if (custo.moeda === 'USD') {
                        totalCustos += custo.valor * cotacaoDolar;
                    } else {
                        totalCustos += custo.valor;
                    }
                }
            });
            
            document.getElementById('total-custos-fixos').textContent = formatarMoeda(totalCustos);
        }

        function calcularCustoFixoProporcional() {
            const vendasEsperadas = parseInt(document.getElementById('vendas-esperadas').value) || 100;
            const cotacaoDolar = parseFloat(document.getElementById('cotacaoDolar').value) || 5.0;
            const custoBase = parseFloat(document.getElementById('custoDolar').value) * cotacaoDolar;
            
            let custoFixoTotal = 0;
            let percentualTotal = 0;
            
            custosFixos.filter(c => c.ativo).forEach(custo => {
                if (custo.tipo === 'fixo') {
                    if (custo.moeda === 'USD') {
                        custoFixoTotal += custo.valor * cotacaoDolar;
                    } else {
                        custoFixoTotal += custo.valor;
                    }
                } else if (custo.tipo === 'percentual') {
                    percentualTotal += custo.valor;
                }
            });
            
            // Custo fixo proporcional por unidade
            const custoFixoPorUnidade = custoFixoTotal / vendasEsperadas;
            
            // Adicionar percentuais
            const custoComPercentuais = custoBase * (1 + percentualTotal / 100);
            
            return {
                fixoPorUnidade: custoFixoPorUnidade,
                percentualTotal: percentualTotal,
                totalMensal: custoFixoTotal
            };
        }

        // Cálculo Principal
        function calcularPreco() {
            // Obter valores
            const nomeProduto = document.getElementById('nomeProduto').value;
            const custoDolar = parseFloat(document.getElementById('custoDolar').value);
            const cotacaoDolar = parseFloat(document.getElementById('cotacaoDolar').value);
            const margemLucro = parseFloat(document.getElementById('margemLucro').value);
            const quantidade = parseInt(document.getElementById('quantidade').value);
            const metodoPagamento = document.getElementById('metodoPagamento').value;
            const taxaYampi = parseFloat(document.getElementById('taxaYampi').value) / 100;
            const taxaImposto = parseFloat(document.getElementById('taxaImposto').value) / 100;
            
            // Validações
            if (!nomeProduto || !custoDolar || !cotacaoDolar || !margemLucro) {
                mostrarNotificacao('Por favor, preencha todos os campos obrigatórios', 'error');
                return;
            }
            
            // Cálculos
            const custoReais = custoDolar * cotacaoDolar;
            
            // Custos fixos proporcionais
            const custosFixosCalc = calcularCustoFixoProporcional();
            const custoComFixos = custoReais + custosFixosCalc.fixoPorUnidade;
            
            // Taxa de pagamento
            const taxaPagamento = metodoPagamento === 'pix' ? 0.0079 : 0.1435;
            
            // Todas as taxas
            const totalTaxas = taxaPagamento + taxaYampi + taxaImposto + (custosFixosCalc.percentualTotal / 100);
            
            // Preço com margem
            const precoComMargem = custoComFixos * (1 + margemLucro / 100);
            
            // Preço final considerando taxas
            const precoFinal = precoComMargem / (1 - totalTaxas);
            
            // Valores das taxas
            const valorTaxaPagamento = precoFinal * taxaPagamento;
            const valorYampi = precoFinal * taxaYampi;
            const valorImposto = precoFinal * taxaImposto;
            const valorTaxasPercentuais = precoFinal * (custosFixosCalc.percentualTotal / 100);
            
            // Lucro real
            const lucroReal = precoFinal - custoComFixos - valorTaxaPagamento - valorYampi - valorImposto - valorTaxasPercentuais;
            
            // Atualizar interface
            document.getElementById('res-custo-reais').textContent = formatarMoeda(custoReais);
            document.getElementById('res-custos-fixos').textContent = formatarMoeda(custosFixosCalc.fixoPorUnidade);
            document.getElementById('res-taxas').textContent = formatarMoeda(valorTaxaPagamento + valorYampi + valorImposto + valorTaxasPercentuais);
            document.getElementById('res-lucro').textContent = formatarMoeda(lucroReal);
            document.getElementById('res-preco-final').textContent = formatarMoeda(precoFinal);
            document.getElementById('res-quantidade').textContent = quantidade;
            document.getElementById('res-preco-total').textContent = formatarMoeda(precoFinal * quantidade);
            
            // Mostrar resultado
            document.getElementById('resultado').style.display = 'block';
            
            // Atualizar gráfico
            atualizarGraficoDistribuicao({
                custoBase: custoReais,
                custosFixos: custosFixosCalc.fixoPorUnidade,
                taxaPagamento: valorTaxaPagamento,
                taxaYampi: valorYampi,
                taxaImposto: valorImposto,
                taxasPercentuais: valorTaxasPercentuais,
                lucro: lucroReal
            });
            
            // Armazenar cálculo atual
            window.calculoAtual = {
                nomeProduto,
                dataCotacao: document.getElementById('dataCotacao').value,
                custoDolar,
                cotacaoDolar,
                custoReais,
                margemLucro,
                quantidade,
                metodoPagamento,
                custosFixos: custosFixosCalc,
                precoFinal,
                lucroReal,
                observacoes: document.getElementById('observacoes').value
            };
        }

        function atualizarGraficoDistribuicao(dados) {
            const ctx = document.getElementById('graficoDistribuicao').getContext('2d');
            
            if (chartDistribuicao) {
                chartDistribuicao.destroy();
            }
            
            chartDistribuicao = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Custo Base', 'Custos Fixos', 'Taxa Pagamento', 'Yampi', 'Imposto', 'Taxas %', 'Lucro'],
                    datasets: [{
                        data: [
                            dados.custoBase,
                            dados.custosFixos,
                            dados.taxaPagamento,
                            dados.taxaYampi,
                            dados.taxaImposto,
                            dados.taxasPercentuais,
                            dados.lucro
                        ],
                        backgroundColor: [
                            '#0d838c',
                            '#0fa3af',
                            '#4cc9f0',
                            '#7209b7',
                            '#f72585',
                            '#ffd60a',
                            '#4cc9f0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatarMoeda(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Aplicar tema
            atualizarTemaGrafico(chartDistribuicao);
        }

        // Cotação Functions
        async function atualizarCotacao() {
            const btn = event ? event.target : document.querySelector('[onclick="atualizarCotacao()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>';
            btn.disabled = true;
            
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                
                if (data && data.rates && data.rates.BRL) {
                    const cotacao = data.rates.BRL;
                    document.getElementById('cotacaoDolar').value = cotacao.toFixed(2);
                    
                    // Salvar no histórico
                    salvarCotacaoHistorico(cotacao);
                    
                    // Atualizar custos fixos
                    atualizarResumoCustosFixos();
                    
                    mostrarNotificacao('Cotação atualizada com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao buscar cotação:', error);
                mostrarNotificacao('Erro ao atualizar cotação. Usando valor padrão.', 'error');
                document.getElementById('cotacaoDolar').value = '5.00';
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function salvarCotacaoHistorico(cotacao) {
            cotacaoHistorico.push({
                data: new Date().toISOString(),
                valor: cotacao
            });
            
            // Manter apenas últimos 30 registros
            if (cotacaoHistorico.length > 30) {
                cotacaoHistorico = cotacaoHistorico.slice(-30);
            }
            
            salvarDados();
        }

        function atualizarGraficoCotacao() {
            const ctx = document.getElementById('cotacaoChart').getContext('2d');
            
            if (chartCotacao) {
                chartCotacao.destroy();
            }
            
            const labels = cotacaoHistorico.map(item => {
                const data = new Date(item.data);
                return `${data.getDate()}/${data.getMonth() + 1}`;
            });
            
            const valores = cotacaoHistorico.map(item => item.valor);
            
            chartCotacao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cotação do Dólar (R$)',
                        data: valores,
                        borderColor: '#0d838c',
                        backgroundColor: 'rgba(13, 131, 140, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
            
            atualizarTemaGrafico(chartCotacao);
        }

        // Orçamentos Functions
        function salvarOrcamento() {
            if (!window.calculoAtual) {
                mostrarNotificacao('Calcule o preço primeiro!', 'error');
                return;
            }
            
            const orcamento = {
                ...window.calculoAtual,
                id: Date.now(),
                dataCriacao: new Date().toISOString()
            };
            
            orcamentosSalvos.push(orcamento);
            salvarDados();
            atualizarOrcamentosSalvos();
            atualizarDashboard();
            
            mostrarNotificacao('Orçamento salvo com sucesso!', 'success');
            
            // Limpar formulário
            document.getElementById('calculator-form').reset();
            document.getElementById('dataCotacao').valueAsDate = new Date();
            document.getElementById('resultado').style.display = 'none';
        }

        function atualizarOrcamentosSalvos() {
            const container = document.getElementById('orcamentos-salvos');
            
            if (orcamentosSalvos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray);">Nenhum orçamento salvo ainda.</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table"><thead><tr>';
            html += '<th>Produto</th><th>Data</th><th>Custo</th><th>Preço</th><th>Lucro</th><th>Ações</th>';
            html += '</tr></thead><tbody>';
            
            orcamentosSalvos.slice().reverse().forEach(orcamento => {
                html += `
                    <tr>
                        <td>${orcamento.nomeProduto}</td>
                        <td>${new Date(orcamento.dataCotacao).toLocaleDateString('pt-BR')}</td>
                        <td>${formatarMoeda(orcamento.custoReais)}</td>
                        <td>${formatarMoeda(orcamento.precoFinal)}</td>
                        <td>${formatarMoeda(orcamento.lucroReal)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="excluirOrcamento(${orcamento.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function excluirOrcamento(id) {
            if (confirm('Tem certeza que deseja excluir este orçamento?')) {
                orcamentosSalvos = orcamentosSalvos.filter(o => o.id !== id);
                salvarDados();
                atualizarOrcamentosSalvos();
                atualizarDashboard();
                mostrarNotificacao('Orçamento excluído!', 'success');
            }
        }

        function compartilharOrcamento() {
            if (!window.calculoAtual) return;
            
            const texto = `
Orçamento: ${window.calculoAtual.nomeProduto}
Preço Unitário: ${formatarMoeda(window.calculoAtual.precoFinal)}
Quantidade: ${window.calculoAtual.quantidade}
Total: ${formatarMoeda(window.calculoAtual.precoFinal * window.calculoAtual.quantidade)}
            `.trim();
            
            if (navigator.share) {
                navigator.share({
                    title: 'Orçamento LED LINE',
                    text: texto
                });
            } else {
                navigator.clipboard.writeText(texto);
                mostrarNotificacao('Orçamento copiado para a área de transferência!', 'success');
            }
        }

        function exportarPDF() {
            if (!window.calculoAtual) {
                mostrarNotificacao('Calcule o preço primeiro!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(13, 131, 140);
            doc.text('LED LINE BR PARTS', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text('Orçamento', 105, 30, { align: 'center' });
            
            // Content
            doc.setFontSize(12);
            let y = 50;
            
            doc.text(`Produto: ${window.calculoAtual.nomeProduto}`, 20, y);
            y += 10;
            doc.text(`Data: ${new Date(window.calculoAtual.dataCotacao).toLocaleDateString('pt-BR')}`, 20, y);
            y += 10;
            doc.text(`Quantidade: ${window.calculoAtual.quantidade} unidades`, 20, y);
            y += 20;
            
            doc.text(`Custo em Dólar: ${formatarMoeda(window.calculoAtual.custoDolar, 'USD')}`, 20, y);
            y += 10;
            doc.text(`Cotação: ${formatarMoeda(window.calculoAtual.cotacaoDolar)}`, 20, y);
            y += 10;
            doc.text(`Custo em Reais: ${formatarMoeda(window.calculoAtual.custoReais)}`, 20, y);
            y += 20;
            
            doc.setFontSize(14);
            doc.setTextColor(13, 131, 140);
            doc.text(`Preço Unitário: ${formatarMoeda(window.calculoAtual.precoFinal)}`, 20, y);
            y += 10;
            doc.text(`Preço Total: ${formatarMoeda(window.calculoAtual.precoFinal * window.calculoAtual.quantidade)}`, 20, y);
            
            // Save
            doc.save(`orcamento_${window.calculoAtual.nomeProduto.replace(/\s+/g, '_')}.pdf`);
            mostrarNotificacao('PDF exportado com sucesso!', 'success');
        }

        function exportarCSV() {
            if (orcamentosSalvos.length === 0) {
                mostrarNotificacao('Não há orçamentos para exportar', 'error');
                return;
            }
            
            let csv = 'Produto,Data,Custo Dólar,Cotação,Custo Reais,Margem,Preço Final,Quantidade,Lucro\n';
            
            orcamentosSalvos.forEach(o => {
                csv += `"${o.nomeProduto}",`;
                csv += `"${new Date(o.dataCotacao).toLocaleDateString('pt-BR')}",`;
                csv += `"${o.custoDolar}",`;
                csv += `"${o.cotacaoDolar}",`;
                csv += `"${o.custoReais.toFixed(2)}",`;
                csv += `"${o.margemLucro}%",`;
                csv += `"${o.precoFinal.toFixed(2)}",`;
                csv += `"${o.quantidade}",`;
                csv += `"${o.lucroReal.toFixed(2)}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'orcamentos_led_line.csv';
            link.click();
            
            mostrarNotificacao('CSV exportado com sucesso!', 'success');
        }

        function limparTodos() {
            if (confirm('Tem certeza que deseja excluir TODOS os orçamentos?')) {
                orcamentosSalvos = [];
                salvarDados();
                atualizarOrcamentosSalvos();
                atualizarDashboard();
                mostrarNotificacao('Todos os orçamentos foram excluídos!', 'success');
            }
        }

        // Dashboard Functions
        function atualizarDashboard() {
            // Totais
            const totalOrcamentos = orcamentosSalvos.length;
            const valorTotal = orcamentosSalvos.reduce((sum, o) => sum + (o.precoFinal * o.quantidade), 0);
            const ticketMedio = totalOrcamentos > 0 ? valorTotal / totalOrcamentos : 0;
            const margemMedia = totalOrcamentos > 0 
                ? orcamentosSalvos.reduce((sum, o) => sum + o.margemLucro, 0) / totalOrcamentos 
                : 0;
            
            document.getElementById('dash-total-orcamentos').textContent = totalOrcamentos;
            document.getElementById('dash-valor-total').textContent = formatarMoeda(valorTotal);
            document.getElementById('dash-ticket-medio').textContent = formatarMoeda(ticketMedio);
            document.getElementById('dash-margem-media').textContent = margemMedia.toFixed(1) + '%';
            
            // Gráfico de vendas
            atualizarGraficoVendas();
        }

        function atualizarGraficoVendas() {
            const ctx = document.getElementById('vendas-chart');
            if (!ctx) return;
            
            if (chartVendas) {
                chartVendas.destroy();
            }
            
            // Agrupar por mês
            const vendaPorMes = {};
            orcamentosSalvos.forEach(o => {
                const data = new Date(o.dataCotacao);
                const mes = `${data.getMonth() + 1}/${data.getFullYear()}`;
                
                if (!vendaPorMes[mes]) {
                    vendaPorMes[mes] = 0;
                }
                vendaPorMes[mes] += o.precoFinal * o.quantidade;
            });
            
            const labels = Object.keys(vendaPorMes);
            const valores = Object.values(vendaPorMes);
            
            chartVendas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vendas por Mês',
                        data: valores,
                        backgroundColor: '#0d838c',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatarMoeda(value);
                                }
                            }
                        }
                    }
                }
            });
            
            atualizarTemaGrafico(chartVendas);
        }

        // Storage Functions
        function carregarDados() {
            const dados = localStorage.getItem('ledLineCalculadora');
            if (dados) {
                const parsed = JSON.parse(dados);
                custosFixos = parsed.custosFixos || [];
                orcamentosSalvos = parsed.orcamentosSalvos || [];
                cotacaoHistorico = parsed.cotacaoHistorico || [];
            }
        }

        function salvarDados() {
            const dados = {
                custosFixos,
                orcamentosSalvos,
                cotacaoHistorico
            };
            localStorage.setItem('ledLineCalculadora', JSON.stringify(dados));
        }

        // Utility Functions
        function formatarMoeda(valor, moeda = 'BRL') {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: moeda
            }).format(valor);
        }

        function mostrarNotificacao(mensagem, tipo = 'success') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('i');
            
            // Update icon
            icon.className = tipo === 'error' ? 'fas fa-exclamation-circle' : 
                           tipo === 'warning' ? 'fas fa-exclamation-triangle' : 
                           'fas fa-check-circle';
            
            // Update class
            notification.className = `notification ${tipo}`;
            
            // Update text
            document.getElementById('notification-text').textContent = mensagem;
            
            // Show
            notification.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registrado'))
                .catch(err => console.error('Erro ao registrar Service Worker:', err));
        }
    </script>
</body>
</html>
